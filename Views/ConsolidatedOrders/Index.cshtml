@{
    ViewData["Title"] = "Consolidated Order";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="mt-2">
    <div class="card mb-2">
        <div class="card-header text-white p-2" style="background-color:#FC2947;">
            <div class="d-flex align-items-center">
                <a href="@Url.Action("Index", "DealerOrders")" class="btn btn-link text-white p-0 mr-2">
                    <i class="fa fa-arrow-left"></i>
                </a>
                <h5 class="mb-0 text-white font-weight-bold">Consolidated Order</h5>
            </div>
        </div>
        <div class="card-body p-2">
            <div class="row mb-2">
                <div class="col-12 col-md-4 mb-2 mb-md-0">
                    <label for="orderDate" class="form-label font-weight-bold mb-1">Order Date:</label>
                    <input type="date" id="orderDate" class="form-control form-control-sm" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-12 col-md-4 mb-2 mb-md-0">
                    <label for="customerFilter" class="form-label font-weight-bold mb-1">Customer/Distributor:</label>
                    <select id="customerFilter" class="form-control form-control-sm select2">
                        <option value="">-- Select Customer --</option>
                    </select>
                </div>
                <div class="col-12 col-md-4">
                    <div class="d-flex flex-column h-100 justify-content-end">
                        <div class="d-flex justify-content-between justify-content-md-end align-items-center">
                            <div class="d-flex mr-2">
                                <span class="badge badge-warning mr-1 p-1 cursor-pointer" id="pendingBadge" data-toggle="modal" data-target="#dealerListModal" data-status="pending">Pending: <span id="pendingOrdersCount">0</span></span>
                                <span class="badge badge-success p-1 cursor-pointer" id="completedBadge" data-toggle="modal" data-target="#dealerListModal" data-status="completed">Completed: <span id="completedOrdersCount">0</span></span>
                            </div>
                            <button id="filterBtn" class="btn btn-primary btn-sm mr-1">
                                <i class="fas fa-filter"></i> <span class="d-none d-sm-inline">Filter</span>
                            </button>
                            <button id="exportBtn" class="btn btn-success btn-sm" disabled>
                                <i class="fas fa-file-excel"></i> <span class="d-none d-sm-inline">Export</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mb-2">
                <div class="col-12">
                    <div class="d-flex flex-wrap">
                        <button id="saveOrderBtn" class="btn btn-success btn-sm mr-2 mb-2" disabled>
                            <i class="fas fa-save"></i> Save Order
                        </button>
                        <a href="@Url.Action("Index", "DealerOrders")" class="btn btn-secondary btn-sm mb-2">
                            <i class="fas fa-arrow-left"></i> Back
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Dealer Details Section -->
            <div class="row mb-2">
                <div class="col-12">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white p-2">
                            <h6 class="mb-0">Dealer Order Status</h6>
                        </div>
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-around flex-wrap">
                                <div class="p-1 text-center cursor-pointer" id="pendingCard" data-status="pending" data-toggle="modal" data-target="#dealerListModal">
                                    <h5 class="mb-0 font-weight-bold text-warning"><span id="pendingOrdersCountLarge">0</span></h5>
                                    <p class="mb-0 small">Pending</p>
                                </div>
                                <div class="p-1 text-center cursor-pointer" id="completedCard" data-status="completed" data-toggle="modal" data-target="#dealerListModal">
                                    <h5 class="mb-0 font-weight-bold text-success"><span id="completedOrdersCountLarge">0</span></h5>
                                    <p class="mb-0 small">Completed</p>
                                </div>
                                <div class="p-1 text-center">
                                    <h5 class="mb-0 font-weight-bold text-primary"><span id="totalDealersCount">0</span></h5>
                                    <p class="mb-0 small">Total</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-12">
                    <div class="table-responsive">
                        <table id="consolidatedTable" class="table table-striped table-bordered table-sm" style="width:100%">
                            <thead class="thead-dark">
                                <tr>
                                    <!-- Material name column hidden on small screens, visible on medium and up -->
                                    <th class="d-none d-md-table-cell">Material</th>
                                    <th>Code</th>
                                    <th>Order Qty</th>
                                    <th>Unit</th>
                                    <th>Items per Box</th>
                                    <th>In Crates</th>
                                    <th>Items to Add</th>
                                    <th>Action</th> <!-- New column for manage button -->
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="8" class="text-center">Select date & customer, click Filter</td></tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <!-- Material name column hidden on small screens, visible on medium and up -->
                                    <th class="d-none d-md-table-cell" colspan="2" class="text-right">Total:</th>
                                    <th class="d-md-none">Total:</th>
                                    <th id="grandTotal">0</th>
                                    <th></th>
                                    <th id="totalItemsPerCrate">0</th>
                                    <th id="totalItemsInCrates">0</th>
                                    <th id="totalLeftoverItems">0</th>
                                    <th></th> <!-- Empty footer for action column -->
                                </tr>
                                <tr>
                                    <td class="d-none d-md-table-cell" colspan="6" class="text-right">Total items to add:</td>
                                    <td class="d-md-none" colspan="4">Items to add:</td>
                                    <td id="totalItemsNeeded">0</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Initialize Select2
            $('.select2').select2({
                width: '100%',
                placeholder: "-- Select Customer --",
                allowClear: true
            });
            
            // Load customers/distributors
            loadCustomers();
            
            // Remove automatic data loading on page load
            // loadData(); // This line is removed
            
            // Filter button click event
            $('#filterBtn').on('click', function () {
                loadData();
            });
            
            // Export button click event
            $('#exportBtn').on('click', function () {
                exportToExcel();
            });
            
            // Save Order button click event
            $('#saveOrderBtn').on('click', function () {
                saveOrder();
            });
            
            // Date change event
            $('#orderDate').on('change', function () {
                // User needs to click the Filter button to refresh data
            });
            
            // Customer filter change event
            $('#customerFilter').on('change', function () {
                // User needs to click the Filter button to refresh data
            });
            
            function loadCustomers() {
                $.ajax({
                    url: '@Url.Action("GetAllCustomers", "ConsolidatedOrders")',
                    type: 'GET',
                    success: function (result) {
                        if (result.success) {
                            var select = $('#customerFilter');
                            select.empty().append('<option value="">-- Select Customer --</option>');
                            
                            $.each(result.customers, function (index, customer) {
                                select.append('<option value="' + customer.id + '">' + customer.name + '</option>');
                            });
                        }
                    },
                    error: function () {
                        console.log('Error loading customers');
                    }
                });
            }
            
            function loadData() {
                var date = $('#orderDate').val();
                var customerId = $('#customerFilter').val();
                
                // Validate that both date and customer are selected
                if (!date || !customerId) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Missing Filters',
                        text: 'Please select both a date and a customer to load data.',
                        confirmButtonText: 'OK'
                    });
                    return;
                }
                
                $.ajax({
                    url: '@Url.Action("GetConsolidatedOrderData", "ConsolidatedOrders")',
                    type: 'GET',
                    data: {
                        date: date,
                        customerId: customerId
                    },
                    success: function (result) {
                        if (result.success) {
                            var tbody = $('#consolidatedTable tbody');
                            tbody.empty();
                            
                            // Update dealer details section with counts
                            updateDealerDetails(result.dealerDetails, customerId);
                            
                            if (result.data && result.data.length > 0) {
                                var hasLeftoverItems = false;
                                var totalItemsNeeded = 0;
                                
                                $.each(result.data, function (index, item) {
                                    var leftoverItems = item.leftoverItems || 0;
                                    var totalQuantityPerUnit = item.totalQuantityPerUnit || 1;
                                    
                                    // Calculate items needed to complete one crate
                                    var itemsNeeded = totalQuantityPerUnit - leftoverItems;
                                    totalItemsNeeded += itemsNeeded;
                                    
                                    // Check if there are any leftover items
                                    if (leftoverItems > 0) {
                                        hasLeftoverItems = true;
                                    }
                                    
                                    // Material name cell hidden on small screens, visible on medium and up
                                    var materialCell = '<td class="d-none d-md-table-cell">' + (item.materialName || '') + '</td>';
                                    
                                    // Add manage button only for items with leftover items
                                    var actionCell = '';
                                    if (leftoverItems > 0) {
                                        actionCell = '<td><button class="btn btn-sm btn-primary manage-quantity-btn" ' +
                                            'data-material-name="' + (item.materialName || '') + '" ' +
                                            'data-short-code="' + (item.shortCode || '') + '" ' +
                                            'data-unit-type="' + (item.unitType || 'PCS') + '" ' +
                                            'data-total-quantity="' + (item.quantity || 0) + '" ' +
                                            'data-total-quantity-per-unit="' + totalQuantityPerUnit + '" ' +
                                            'data-leftover-items="' + leftoverItems + '" ' +
                                            'data-crates="' + (item.crates || 0) + '" ' +
                                            'data-customer-id="' + customerId + '" ' +
                                            'data-date="' + date + '">' +
                                            '<i class="fas fa-edit"></i>' +
                                            '</button></td>';
                                    } else {
                                        actionCell = '<td></td>';
                                    }
                                    
                                    var row = '<tr>' +
                                        materialCell +
                                        '<td>' + (item.shortCode || '') + '</td>' +
                                        '<td>' + (item.quantity || 0) + '</td>' +
                                        '<td>' + (item.unitType || 'PCS') + '</td>' +
                                        '<td>' + totalQuantityPerUnit + '</td>' +
                                        '<td>' + (item.itemsInCrates || 0) + '</td>' +
                                        '<td class="' + (leftoverItems > 0 ? 'text-danger font-weight-bold' : (leftoverItems === 0 ? 'text-success font-weight-bold' : '')) + '">' + 
                                        (leftoverItems > 0 ? 'Add ' + (item.totalQuantityPerUnit - leftoverItems) + ' items' : (leftoverItems === 0 ? 'Complete' : '')) + 
                                        '</td>' +
                                        actionCell +
                                        '</tr>';
                                    tbody.append(row);
                                });
                                
                                // Enable or disable the save button based on leftover items
                                if (hasLeftoverItems) {
                                    $('#saveOrderBtn').prop('disabled', true);
                                    $('#saveOrderBtn').attr('title', 'Cannot save order while there are leftover items');
                                } else {
                                    $('#saveOrderBtn').prop('disabled', false);
                                    $('#saveOrderBtn').removeAttr('title');
                                }
                                
                                // Enable export button
                                $('#exportBtn').prop('disabled', false);
                                
                                // Update grand totals
                                $('#grandTotal').text(result.grandTotal);
                                $('#totalItemsPerCrate').text(result.totalItemsPerCrate);
                                $('#totalItemsInCrates').text(result.totalItemsInCrates);
                                $('#totalLeftoverItems').text(result.totalLeftoverItems);
                                $('#totalItemsNeeded').text(totalItemsNeeded);
                            } else {
                                // Adjust colspan based on screen size
                                var colspan = $(window).width() < 768 ? 7 : 8;
                                tbody.append('<tr><td colspan="' + colspan + '" class="text-center">No data found</td></tr>');
                                $('#grandTotal').text('0');
                                $('#totalItemsPerCrate').text('0');
                                $('#totalItemsInCrates').text('0');
                                $('#totalLeftoverItems').text('0');
                                $('#totalItemsNeeded').text('0');
                                
                                // Disable buttons when no data
                                $('#saveOrderBtn').prop('disabled', true);
                                $('#exportBtn').prop('disabled', true);
                            }
                        } else {
                            // Adjust colspan based on screen size
                            var colspan = $(window).width() < 768 ? 7 : 8;
                            $('#consolidatedTable tbody').empty().append('<tr><td colspan="' + colspan + '" class="text-center">Error: ' + result.message + '</td></tr>');
                            $('#grandTotal').text('0');
                            $('#totalItemsPerCrate').text('0');
                            $('#totalItemsInCrates').text('0');
                            $('#totalLeftoverItems').text('0');
                            $('#totalItemsNeeded').text('0');
                            
                            // Disable buttons on error
                            $('#saveOrderBtn').prop('disabled', true);
                            $('#exportBtn').prop('disabled', true);
                        }
                    },
                    error: function () {
                        // Adjust colspan based on screen size
                        var colspan = $(window).width() < 768 ? 7 : 8;
                        $('#consolidatedTable tbody').empty().append('<tr><td colspan="' + colspan + '" class="text-center">Error loading data</td></tr>');
                        $('#grandTotal').text('0');
                        $('#totalItemsPerCrate').text('0');
                        $('#totalItemsInCrates').text('0');
                        $('#totalLeftoverItems').text('0');
                        $('#totalItemsNeeded').text('0');
                        
                        // Disable buttons on error
                        $('#saveOrderBtn').prop('disabled', true);
                        $('#exportBtn').prop('disabled', true);
                    }
                });
            }
            
            // Handle manage quantity button click
            $(document).on('click', '.manage-quantity-btn', function() {
                var materialName = $(this).data('material-name');
                var shortCode = $(this).data('short-code');
                var unitType = $(this).data('unit-type');
                var totalQuantity = $(this).data('total-quantity');
                var totalQuantityPerUnit = $(this).data('total-quantity-per-unit');
                var leftoverItems = $(this).data('leftover-items');
                var crates = $(this).data('crates');
                var customerId = $(this).data('customer-id');
                var date = $(this).data('date');
                
                // Show the manage quantity modal
                showManageQuantityModal(materialName, shortCode, unitType, totalQuantity, totalQuantityPerUnit, leftoverItems, crates, customerId, date);
            });
            
            function showManageQuantityModal(materialName, shortCode, unitType, totalQuantity, totalQuantityPerUnit, leftoverItems, crates, customerId, date) {
                // Calculate items needed to complete one crate
                var itemsNeeded = totalQuantityPerUnit - leftoverItems;
                var currentTotalQuantity = totalQuantity;
                
                // Create the modal HTML with improved styling
                var modalHtml = `
                <div class="modal fade" id="manageQuantityModal" tabindex="-1" role="dialog" aria-labelledby="manageQuantityModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg" role="document">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white p-2">
                                <h5 class="modal-title" id="manageQuantityModalLabel"><i class="fas fa-box-open"></i> Manage Quantity for ${materialName}</h5>
                                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body p-2">
                                <div class="alert alert-info p-2 mb-2">
                                    <strong><i class="fas fa-info-circle"></i> Items needed to complete one crate:</strong> <span id="itemsNeededValue" class="${itemsNeeded > 0 ? 'text-warning font-weight-bold' : 'text-success font-weight-bold'}">${itemsNeeded}</span> items
                                </div>
                                
                                <div class="row mb-2">
                                    <div class="col-lg-6 col-sm-12 mb-2">
                                        <div class="card border-primary h-100 shadow-sm">
                                            <div class="card-header bg-primary text-white p-1">
                                                <h6 class="mb-0"><i class="fas fa-info-circle"></i> Current Information</h6>
                                            </div>
                                            <div class="card-body p-1">
                                                <table class="table table-sm mb-0">
                                                    <tr><td><strong>Material:</strong></td><td>${materialName}</td></tr>
                                                    <tr><td><strong>Code:</strong></td><td>${shortCode}</td></tr>
                                                    <tr><td><strong>Unit Type:</strong></td><td>${unitType}</td></tr>
                                                    <tr><td><strong>Total Quantity:</strong></td><td><span id="currentTotalQuantity">${currentTotalQuantity}</span></td></tr>
                                                    <tr><td><strong>Items per Crate:</strong></td><td>${totalQuantityPerUnit}</td></tr>
                                                    <tr><td><strong>Current Crates:</strong></td><td><span id="currentCrates">${crates}</span></td></tr>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-6 col-sm-12 mb-2">
                                        <div class="card border-success h-100 shadow-sm">
                                            <div class="card-header bg-success text-white p-1">
                                                <h6 class="mb-0"><i class="fas fa-sync-alt"></i> Live Update</h6>
                                            </div>
                                            <div class="card-body p-1">
                                                <table class="table table-sm mb-0">
                                                    <tr><td><strong>New Total Qty:</strong></td><td><span id="newTotalQuantity">${currentTotalQuantity}</span></td></tr>
                                                    <tr><td><strong>New Crates:</strong></td><td><span id="newCrates">${crates}</span></td></tr>
                                                    <tr><td><strong>Items Needed:</strong></td><td><span id="liveItemsNeeded" class="${itemsNeeded > 0 ? 'text-warning font-weight-bold' : 'text-success font-weight-bold'}">${itemsNeeded}</span></td></tr>
                                                    <tr><td><strong>Status:</strong></td><td><span id="crateStatus" class="${itemsNeeded > 0 ? 'text-warning' : 'text-success'}">${itemsNeeded > 0 ? '<i class="fas fa-exclamation-triangle"></i> Incomplete' : '<i class="fas fa-check-circle"></i> Complete'}</span></td></tr>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card border-secondary shadow-sm">
                                            <div class="card-header bg-secondary text-white p-1">
                                                <h6 class="mb-0"><i class="fas fa-users"></i> Dealer Orders Adjustment</h6>
                                            </div>
                                            <div class="card-body p-1">
                                                <div id="dealerOrdersContainer">
                                                    <div class="text-center">
                                                        <div class="spinner-border" role="status">
                                                            <span class="sr-only">Loading...</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer p-2">
                                <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal"><i class="fas fa-times"></i> Cancel</button>
                                <button type="button" class="btn btn-primary btn-sm" id="saveQuantityChanges"><i class="fas fa-save"></i> Save Changes</button>
                            </div>
                        </div>
                    </div>
                </div>`;
                
                // Remove any existing modal
                $('#manageQuantityModal').remove();
                
                // Append the modal to the body
                $('body').append(modalHtml);
                
                // Show the modal
                $('#manageQuantityModal').modal('show');
                
                // Load dealer orders for this material
                loadDealerOrdersForMaterial(materialName, shortCode, totalQuantity, totalQuantityPerUnit, customerId, date, itemsNeeded);
            }
            
            function loadDealerOrdersForMaterial(materialName, shortCode, totalQuantity, totalQuantityPerUnit, customerId, date, initialItemsNeeded) {
                $.ajax({
                    url: '@Url.Action("GetDealerOrdersForMaterial", "ConsolidatedOrders")',
                    type: 'GET',
                    data: {
                        materialName: materialName,
                        customerId: customerId,
                        date: date
                    },
                    success: function(result) {
                        if (result.success) {
                            var container = $('#dealerOrdersContainer');
                            var html = '';
                            
                            if (result.dealerOrders && result.dealerOrders.length > 0) {
                                // Use the totalQuantityPerUnit from the first item (should be the same for all)
                                var itemsPerCrate = result.dealerOrders[0].totalQuantityPerUnit || totalQuantityPerUnit;
                                var currentTotalQuantity = totalQuantity;
                                
                                html += '<div class="table-responsive">';
                                html += '<table class="table table-sm table-bordered mb-0">';
                                html += '<thead class="thead-dark"><tr><th>Dealer</th><th>Current</th><th>Adjust</th><th>New Qty</th></tr></thead>';
                                html += '<tbody>';
                                
                                $.each(result.dealerOrders, function(index, order) {
                                    var currentQty = order.quantity || 0;
                                    var shortCode = order.shortCode || ''; // Get shortCode from the response
                                    html += '<tr>';
                                    html += '<td>' + order.dealerName + '</td>';
                                    html += '<td class="text-center">' + currentQty + '</td>';
                                    html += '<td>';
                                    html += '<div class="input-group input-group-sm">';
                                    html += '<div class="input-group-prepend">';
                                    html += '<button class="btn btn-outline-danger qty-decrease btn-sm p-1" type="button" data-dealer-id="' + order.dealerId + '" data-basic-order-id="' + order.basicOrderId + '"><i class="fas fa-minus"></i></button>';
                                    html += '</div>';
                                    html += '<input type="number" class="form-control text-center dealer-quantity-adjustment p-1" ';
                                    html += 'data-dealer-id="' + order.dealerId + '" ';
                                    html += 'data-basic-order-id="' + order.basicOrderId + '" ';
                                    html += 'data-short-name="' + shortCode + '" '; // Use shortCode from the response
                                    html += 'data-current-quantity="' + currentQty + '" ';
                                    html += 'data-original-total-quantity="' + currentTotalQuantity + '" '; // Store original total quantity
                                    html += 'data-items-per-crate="' + itemsPerCrate + '" '; // Add items per crate data
                                    html += 'value="0" min="-' + currentQty + '" step="1" style="max-width: 60px;">';
                                    html += '<div class="input-group-append">';
                                    html += '<button class="btn btn-outline-success qty-increase btn-sm p-1" type="button" data-dealer-id="' + order.dealerId + '" data-basic-order-id="' + order.basicOrderId + '"><i class="fas fa-plus"></i></button>';
                                    html += '</div>';
                                    html += '</div>';
                                    html += '</td>';
                                    html += '<td class="new-quantity-' + order.dealerId + '-' + order.basicOrderId + ' text-center text-muted">' + currentQty + '</td>';
                                    html += '</tr>';
                                });
                                
                                html += '</tbody></table>';
                                html += '</div>';
                            } else {
                                html = '<p class="text-center mb-0 text-muted">No dealer orders found for this material.</p>';
                            }
                            
                            container.html(html);
                            
                            // Remove any existing event handlers to prevent duplication
                            $('.dealer-quantity-adjustment').off('input');
                            
                        } else {
                            $('#dealerOrdersContainer').html('<p class="text-danger mb-0">Error loading dealer orders: ' + result.message + '</p>');
                        }
                    },
                    error: function() {
                        $('#dealerOrdersContainer').html('<p class="text-danger mb-0">Error loading dealer orders.</p>');
                    }
                });
            }
            
            // Handle quantity increase button
            $(document).on('click', '.qty-increase', function(e) {
                e.preventDefault(); // Prevent any default behavior
                e.stopPropagation(); // Stop event propagation
                
                var inputField = $(this).closest('.input-group').find('.dealer-quantity-adjustment');
                var currentValue = parseInt(inputField.val()) || 0;
                
                // Ensure we only increment by 1
                var newValue = currentValue + 1;
                inputField.val(newValue);
                
                // Get the original total quantity and items per crate from this input
                var originalTotalQuantity = parseInt(inputField.data('original-total-quantity')) || 0;
                var itemsPerCrate = parseInt(inputField.data('items-per-crate')) || 24;
                
                // Trigger the input event to update the display with a small delay
                setTimeout(function() {
                    inputField.trigger('input');
                }, 10);
                
                // Add visual feedback
                $(this).addClass('btn-success');
                setTimeout(() => {
                    $(this).removeClass('btn-success');
                }, 150);
            });
            
            // Handle quantity decrease button
            $(document).on('click', '.qty-decrease', function(e) {
                e.preventDefault(); // Prevent any default behavior
                e.stopPropagation(); // Stop event propagation
                
                var inputField = $(this).closest('.input-group').find('.dealer-quantity-adjustment');
                var currentValue = parseInt(inputField.val()) || 0;
                var minValue = parseInt(inputField.attr('min')) || 0;
                
                // Ensure we only decrement by 1 and don't go below min value
                if (currentValue > minValue) {
                    var newValue = currentValue - 1;
                    inputField.val(newValue);
                    
                    // Get the original total quantity and items per crate from this input
                    var originalTotalQuantity = parseInt(inputField.data('original-total-quantity')) || 0;
                    var itemsPerCrate = parseInt(inputField.data('items-per-crate')) || 24;
                    
                    // Trigger the input event to update the display with a small delay
                    setTimeout(function() {
                        inputField.trigger('input');
                    }, 10);
                    
                    // Add visual feedback
                    $(this).addClass('btn-danger');
                    setTimeout(() => {
                        $(this).removeClass('btn-danger');
                    }, 150);
                }
            });
            
            // Handle quantity adjustment input changes
            // This global event listener handles all dealer quantity adjustments
            $(document).on('input', '.dealer-quantity-adjustment', function() {
                var dealerId = $(this).data('dealer-id');
                var basicOrderId = $(this).data('basic-order-id');
                var currentQuantity = parseInt($(this).data('current-quantity')) || 0;
                var adjustment = parseInt($(this).val()) || 0;
                var newQuantity = currentQuantity + adjustment;
                
                // Update the new quantity display with color coding
                var newQuantityCell = $('.new-quantity-' + dealerId + '-' + basicOrderId);
                newQuantityCell.text(newQuantity);
                
                // Add color coding based on change with more distinct colors
                if (adjustment > 0) {
                    // Positive adjustment - items added
                    newQuantityCell.removeClass('text-danger text-muted').addClass('text-success font-weight-bold');
                    newQuantityCell.html('<i class="fas fa-arrow-up"></i> ' + newQuantity);
                } else if (adjustment < 0) {
                    // Negative adjustment - items removed
                    newQuantityCell.removeClass('text-success text-muted').addClass('text-danger font-weight-bold');
                    newQuantityCell.html('<i class="fas fa-arrow-down"></i> ' + newQuantity);
                } else {
                    // No adjustment
                    newQuantityCell.removeClass('text-success text-danger font-weight-bold').addClass('text-muted');
                    newQuantityCell.html(newQuantity);
                }
                
                // Get the original total quantity and items per crate from this input
                var originalTotalQuantity = parseInt($(this).data('original-total-quantity')) || 0;
                var itemsPerCrate = parseInt($(this).data('items-per-crate')) || 24;
                
                // Update live stats with the original total quantity
                updateLiveStats(originalTotalQuantity, itemsPerCrate);
            });
            
            // Handle save quantity changes button
            $(document).on('click', '#saveQuantityChanges', function() {
                var adjustments = [];
                var customerId = $('#customerFilter').val() || 0; // Get customerId from customer filter
                $('.dealer-quantity-adjustment').each(function() {
                    var dealerId = $(this).data('dealer-id');
                    var dealerOrderId = parseInt(customerId); // Use customerId as dealerOrderId
                    var shortName = $(this).data('short-name') || ''; // Get ShortName from data attribute
                    
                    // Ensure shortName is always a string, even if it's numeric
                    if (typeof shortName === 'number') {
                        shortName = shortName.toString();
                    } else if (typeof shortName !== 'string') {
                        shortName = String(shortName);
                    }
                    
                    var adjustment = parseInt($(this).val()) || 0;
                    
                    if (adjustment !== 0) {
                        adjustments.push({
                            dealerId: dealerId,
                            dealerOrderId: dealerOrderId,
                            shortName: shortName,
                            adjustment: adjustment
                        });
                    }
                });
                
                if (adjustments.length === 0) {
                    Swal.fire({
                        icon: 'info',
                        title: 'No Changes',
                        text: 'No quantity adjustments were made.',
                        confirmButtonText: 'OK'
                    });
                    return;
                }
                
                // Send the adjustments to the server
                $.ajax({
                    url: '@Url.Action("AdjustDealerOrderQuantities", "ConsolidatedOrders")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        adjustments: adjustments
                    }),
                    success: function(result) {
                        if (result.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Success',
                                text: 'Dealer order quantities updated successfully.',
                                confirmButtonText: 'OK'
                            }).then(() => {
                                // Close the modal
                                $('#manageQuantityModal').modal('hide');
                                // Reload the data
                                loadData();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: result.message || 'Failed to update dealer order quantities.',
                                confirmButtonText: 'OK'
                            });
                        }
                    },
                    error: function() {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to update dealer order quantities.',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            });
            
            function updateDealerDetails(dealerDetails, customerId) {
                // Fetch dealer order status counts
                $.ajax({
                    url: '@Url.Action("GetDealersByDistributor", "ConsolidatedOrders")',
                    type: 'GET',
                    data: {
                        distributorId: customerId
                    },
                    success: function (result) {
                        if (result.success) {
                            // Count dealers with and without orders
                            var pendingCount = 0;
                            var completedCount = 0;
                            var pendingDealers = [];
                            var completedDealers = [];
                            
                            $.each(result.dealers, function (index, dealer) {
                                if (dealer.hasOrderedToday) {
                                    completedCount++;
                                    completedDealers.push(dealer);
                                } else {
                                    pendingCount++;
                                    pendingDealers.push(dealer);
                                }
                            });
                            
                            var totalCount = pendingCount + completedCount;
                            
                            // Update the counts in the badges (top right)
                            $('#pendingOrdersCount').text(pendingCount);
                            $('#completedOrdersCount').text(completedCount);
                            
                            // Update the counts in the large cards
                            $('#pendingOrdersCountLarge').text(pendingCount);
                            $('#completedOrdersCountLarge').text(completedCount);
                            $('#totalDealersCount').text(totalCount);
                            
                            // Store dealer lists for modal
                            $('#pendingCard').data('dealers', pendingDealers);
                            $('#completedCard').data('dealers', completedDealers);
                        } else {
                            console.log('Error loading dealer status: ' + result.message);
                        }
                    },
                    error: function () {
                        console.log('Error loading dealer status');
                    }
                });
            }
            
            // Handle card clicks to show dealer list in modal
            $('#dealerListModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget); // Button that triggered the modal
                var status = button.data('status') || $('.cursor-pointer:hover').data('status'); // Extract info from data-* attributes
                var dealers = [];
                
                // Get dealers based on which element was clicked
                if (status === 'pending') {
                    dealers = $('#pendingCard').data('dealers') || [];
                    $('.modal-title').text('Pending Dealers (Not Ordered Yet)');
                } else if (status === 'completed') {
                    dealers = $('#completedCard').data('dealers') || [];
                    $('.modal-title').text('Completed Dealers (Already Ordered)');
                } else {
                    // Default to pending if status not found
                    dealers = $('#pendingCard').data('dealers') || [];
                    $('.modal-title').text('Pending Dealers (Not Ordered Yet)');
                }
                
                var modal = $(this);
                var listHtml = '';
                
                // Populate dealer list
                if (dealers.length > 0) {
                    listHtml = '<ul class="list-group">';
                    $.each(dealers, function(index, dealer) {
                        listHtml += '<li class="list-group-item">' + dealer.name + '</li>';
                    });
                    listHtml += '</ul>';
                } else {
                    listHtml = '<p class="text-center">No dealers found.</p>';
                }
                
                modal.find('.modal-body #dealerList').html(listHtml);
            });
            
            function exportToExcel() {
                var date = $('#orderDate').val();
                var customerId = $('#customerFilter').val();
                var url = '@Url.Action("ExportConsolidatedToExcel", "ConsolidatedOrders")' + 
                          '?date=' + encodeURIComponent(date) + 
                          '&customerId=' + encodeURIComponent(customerId || '');
                window.location.href = url;
            }
            
            function saveOrder() {
                var date = $('#orderDate').val();
                var customerId = $('#customerFilter').val();
                
                if (!date) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Missing Date',
                        text: 'Please select an order date.',
                        confirmButtonText: 'OK'
                    });
                    return;
                }
                
                if (!customerId) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Missing Customer',
                        text: 'Please select a customer/distributor.',
                        confirmButtonText: 'OK'
                    });
                    return;
                }
                
                // Check if there are any leftover items
                var totalLeftoverItems = parseInt($('#totalLeftoverItems').text()) || 0;
                if (totalLeftoverItems > 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Leftover Items',
                        text: 'Cannot save order while there are leftover items. Please adjust quantities to fill complete crates.',
                        confirmButtonText: 'OK'
                    });
                    return;
                }
                
                // Check for pending dealers before saving
                var pendingCount = parseInt($('#pendingOrdersCountLarge').text()) || 0;
                if (pendingCount > 0) {
                    Swal.fire({
                        title: 'Pending Dealers!',
                        text: 'There are still ' + pendingCount + ' dealer(s) who have not submitted their orders yet. Do you want to proceed with saving the consolidated order?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Yes, save it!',
                        cancelButtonText: 'Cancel'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Proceed with saving the order
                            saveOrderConfirmed(date, customerId);
                        }
                    });
                } else {
                    // No pending dealers, proceed with normal save confirmation
                    Swal.fire({
                        title: 'Save Consolidated Order?',
                        text: "This will save the consolidated order data to the purchase table.",
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Yes, save it!',
                        cancelButtonText: 'Cancel'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            saveOrderConfirmed(date, customerId);
                        }
                    });
                }
            }
            
            // Separate function to handle the actual saving logic
            function saveOrderConfirmed(date, customerId) {
                $.ajax({
                    url: '@Url.Action("SaveConsolidatedOrder", "ConsolidatedOrders")',
                    type: 'POST',
                    data: {
                        date: date,
                        customerId: customerId
                    },
                    success: function (result) {
                        if (result.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Order Saved!',
                                text: 'The consolidated order has been saved successfully.',
                                confirmButtonText: 'OK'
                            }).then(() => {
                                // Refresh the page after successful save
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: result.message || 'An error occurred while saving the order.',
                                confirmButtonText: 'OK'
                            });
                        }
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'An error occurred while saving the order.',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            }
            
            function updateLiveStats(currentTotalQuantity, itemsPerCrate) {
                var totalAdjustment = 0;
                
                // Calculate total adjustment from all inputs
                $('.dealer-quantity-adjustment').each(function() {
                    var adjustment = parseInt($(this).val()) || 0;
                    totalAdjustment += adjustment;
                });
                
                // Calculate new total quantity
                var newTotalQuantity = currentTotalQuantity + totalAdjustment;
                
                // Calculate new crates and items needed
                var newCrates = Math.floor(newTotalQuantity / itemsPerCrate);
                var itemsNeeded = itemsPerCrate - (newTotalQuantity % itemsPerCrate);
                if (itemsNeeded === itemsPerCrate) itemsNeeded = 0;
                
                // Update the live stats display with color coding
                $('#newTotalQuantity').text(newTotalQuantity);
                $('#newCrates').text(newCrates);
                
                // Update items needed with color coding
                var itemsNeededElement = $('#liveItemsNeeded');
                itemsNeededElement.text(itemsNeeded);
                
                if (itemsNeeded > 0) {
                    itemsNeededElement.removeClass('text-success').addClass('text-warning font-weight-bold');
                    $('#crateStatus').text('Incomplete').removeClass('text-success').addClass('text-warning');
                } else {
                    itemsNeededElement.removeClass('text-warning').addClass('text-success font-weight-bold');
                    $('#crateStatus').text('Complete').removeClass('text-warning').addClass('text-success');
                }
                
                // Update items needed in the alert
                var itemsNeededAlert = $('#itemsNeededValue');
                itemsNeededAlert.text(itemsNeeded);
                if (itemsNeeded > 0) {
                    itemsNeededAlert.removeClass('text-success').addClass('text-warning font-weight-bold');
                } else {
                    itemsNeededAlert.removeClass('text-warning').addClass('text-success font-weight-bold');
                }
            }
        });
    </script>
    
    <style>
        .cursor-pointer {
            cursor: pointer;
        }
        
        /* Responsive adjustments for small screens */
        @@media (max-width: 575.98px) {
            .card-body {
                padding: 0.5rem !important;
            }
            
            .form-group {
                margin-bottom: 0.75rem;
            }
            
            .mb-2 {
                margin-bottom: 0.5rem !important;
            }
            
            .p-2 {
                padding: 0.5rem !important;
            }
            
            .table th, .table td {
                padding: 0.25rem !important;
                font-size: 0.8rem;
            }
            
            .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.8rem;
            }
            
            .modal-content .card-header {
                padding: 0.25rem !important;
            }
            
            .modal-content .card-body {
                padding: 0.25rem !important;
            }
            
            .modal-content .table th, .modal-content .table td {
                padding: 0.15rem !important;
                font-size: 0.7rem;
            }
            
            .modal-content .input-group .btn {
                padding: 0.1rem 0.25rem;
                font-size: 0.7rem;
            }
            
            .modal-content .form-control {
                padding: 0.1rem 0.25rem;
                font-size: 0.7rem;
                height: calc(1.5em + 0.2rem + 2px);
            }
        }
        
        /* Additional compact styles for modal */
        .modal-content .card {
            margin-bottom: 0.5rem;
        }
        
        .modal-content .card-header h6 {
            font-size: 0.9rem;
        }
        
        .modal-content .table th, .modal-content .table td {
            border: 1px solid #dee2e6;
        }
        
        .modal-content .alert {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
        }
        
        .modal-content .alert strong {
            font-size: 0.9rem;
        }
        
        /* Color coding styles */
        .text-success {
            color: #28a745 !important;
        }
        
        .text-warning {
            color: #ffc107 !important;
        }
        
        .text-danger {
            color: #dc3545 !important;
        }
        
        .text-muted {
            color: #6c757d !important;
        }
        
        .font-weight-bold {
            font-weight: 700 !important;
        }
        
        /* Highlight styles for new quantities */
        .new-quantity-highlight {
            transition: all 0.3s ease;
        }
        
        .new-quantity-highlight.changing {
            background-color: #fff3cd;
            border-radius: 3px;
        }
        
        /* Animation for pulse effect */
        @@keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse-animation {
            animation: pulse 0.5s ease-in-out;
        }
        
        /* Animation for success effect */
        @@keyframes successGlow {
            0% { box-shadow: 0 0 5px #28a745; }
            50% { box-shadow: 0 0 20px #28a745; }
            100% { box-shadow: 0 0 5px #28a745; }
        }
        
        .success-animation {
            animation: successGlow 1s ease-in-out;
        }
        
        /* Button feedback styles */
        .btn-success-temp {
            background-color: #28a745 !important;
            border-color: #28a745 !important;
        }
        
        .btn-danger-temp {
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
        }
        
        /* Highlight effect for changing values */
        .bg-warning.text-dark {
            transition: all 0.3s ease;
        }
        
        /* Card shadow effect */
        .shadow-sm {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
        }
        
        /* Icons in table cells */
        .table td i {
            margin-right: 5px;
        }
    </style>
}

<!-- Dealer List Modal -->
<div class="modal fade" id="dealerListModal" tabindex="-1" role="dialog" aria-labelledby="dealerListModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dealerListModalLabel">Dealer List</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <ul id="dealerList" class="list-group">
                            <!-- Dealer names will be populated here -->
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>