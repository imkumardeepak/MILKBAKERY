@model Milk_Bakery.ViewModels.DealerOrdersViewModel

<div class="row">
    <div class="col-md-12">
        @if (Model.Dealers.Any())
        {
            <form id="saveOrdersForm">
                <input type="hidden" id="SelectedDistributorId" name="SelectedDistributorId" value="@Model.SelectedDistributorId" />
                
                @{ int index = 0; }
                @foreach (var dealer in Model.Dealers)
                {
                    <div class="card shadow mb-3 border-left-primary" id="dealer-card-@dealer.Id">
                        <div class="card-header py-2 d-flex justify-content-between align-items-center" id="heading@(dealer.Id)">
                            <h6 class="m-0 font-weight-bold text-primary">@dealer.Name</h6>
                            <button class="btn btn-link text-primary p-1 accordion-toggle" type="button" data-dealer-id="@dealer.Id">
                                <i class="fas fa-chevron-down toggle-icon"></i>
                            </button>
                        </div>
                        
                        <div id="collapse@(dealer.Id)" class="dealer-collapse-content @(index == 0 ? "" : "d-none")">
                            <div class="card-body p-2">
                                <h6 class="font-weight-bold text-primary mb-2">Order Details</h6>
                                @if (Model.DealerBasicOrders.ContainsKey(dealer.Id) && Model.DealerBasicOrders[dealer.Id].Any())
                                {
                                    decimal dealerTotal = 0; // Variable to store dealer total
                                    
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover table-sm mb-2">
                                            <thead class="thead-dark">
                                                <tr>
                                                    <th>Short Code</th>
                                                    <th class="text-center">Rate</th>
                                                    <th class="text-center">Qty</th>
                                                    <th class="text-center">Price</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var basicOrder in Model.DealerBasicOrders[dealer.Id])
                                                {
                                                    // Get the quantity for this item - either from existing order or basic order
                                                    int quantity = 0;
                                                    if (Model.DealerOrderItemQuantities.ContainsKey(dealer.Id) && 
                                                        Model.DealerOrderItemQuantities[dealer.Id].ContainsKey(basicOrder.Id))
                                                    {
                                                        quantity = Model.DealerOrderItemQuantities[dealer.Id][basicOrder.Id];
                                                    }
                                                    else
                                                    {
                                                        quantity = basicOrder.Quantity;
                                                    }
                                                    
                                                    // Calculate rate and price
                                                    decimal rate = basicOrder.Rate;
                                                    decimal price = rate * quantity;
                                                    dealerTotal += price;
                                                    
                                                    <tr>
                                                        <td>@basicOrder.ShortCode</td>
                                                        <td class="text-center">@rate.ToString("F2")</td>
                                                        <td class="p-1">
                                                            <input type="number" 
                                                                   name="DealerOrderItemQuantities[@dealer.Id][@basicOrder.Id]" 
                                                                   class="form-control form-control-sm text-center quantity-input" 
                                                                   value="@quantity" 
                                                                   min="0" 
                                                                   data-dealer-id="@dealer.Id"
                                                                   data-basic-order-id="@basicOrder.Id"
                                                                   data-rate="@rate" />
                                                        </td>
                                                        <td class="text-center price-cell">@price.ToString("F2")</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="text-right">
                                        <strong class="dealer-total">Dealer Total: ₹@dealerTotal.ToString("F2")</strong>
                                    </div>
                                    
                                    <!-- Save button for individual dealer -->
                                    <div class="text-center mt-2">
                                        <button type="button" class="btn btn-success save-dealer-order-btn" data-dealer-id="@dealer.Id">
                                            <i class="fas fa-save"></i> Save Order for @dealer.Name
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-info py-1 px-2 mb-2" role="alert">
                                        <i class="fas fa-info-circle"></i> No basic orders found for this dealer.
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                    index++;
                }
            </form>
        }
        else
        {
            <div class="alert alert-warning text-center" role="alert">
                <i class="fas fa-exclamation-triangle"></i> No dealers found for the selected distributor.
            </div>
        }
    </div>
</div>

<script>
    $(document).ready(function () {
        // Function to reset button state
        function resetButtonState(button, originalText) {
            button.html(originalText);
            button.prop('disabled', false);
        }
        
        // Handle quantity input changes to update price
        $(document).on('input', '.quantity-input', function() {
            var quantity = parseFloat($(this).val()) || 0;
            var rate = parseFloat($(this).data('rate')) || 0;
            var price = quantity * rate;
            
            // Update the price cell in the same row
            $(this).closest('tr').find('.price-cell').text(price.toFixed(2));
            
            // Recalculate dealer total
            var dealerId = $(this).data('dealer-id');
            recalculateDealerTotal(dealerId);
        });
        
        // Function to recalculate dealer total
        function recalculateDealerTotal(dealerId) {
            var dealerTotal = 0;
            $('#collapse' + dealerId).find('.price-cell').each(function() {
                dealerTotal += parseFloat($(this).text()) || 0;
            });
            
            // Update dealer total display using the correct selector
            $('#collapse' + dealerId).find('.dealer-total').text('Dealer Total: ₹' + dealerTotal.toFixed(2));
        }
        
        // Handle save order for individual dealer
        $(document).on('click', '.save-dealer-order-btn', function () {
            var button = $(this);
            var originalText = button.html();
            var dealerId = button.data('dealer-id');
            var dealerName = $('#dealer-card-' + dealerId).find('.card-header h6').text();
            
            // Show loading indicator
            button.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...');
            button.prop('disabled', true);
            
            // Prepare data for this specific dealer
            var distributorId = $('#SelectedDistributorId').val();
            var dealerData = {};
            
            // Collect data for this dealer only
            $('#dealer-card-' + dealerId).find('.quantity-input').each(function() {
                var dealerId = $(this).data('dealer-id');
                var basicOrderId = $(this).data('basic-order-id');
                var quantity = $(this).val();
                
                if (!dealerData[dealerId]) {
                    dealerData[dealerId] = {};
                }
                dealerData[dealerId][basicOrderId] = quantity;
            });
            
            // Serialize the data properly for the AJAX call
            var formData = 'SelectedDistributorId=' + encodeURIComponent(distributorId);
            
            // Add dealer data
            for (var dealerId in dealerData) {
                for (var basicOrderId in dealerData[dealerId]) {
                    formData += '&DealerOrderItemQuantities[' + encodeURIComponent(dealerId) + '][' + encodeURIComponent(basicOrderId) + ']=' + encodeURIComponent(dealerData[dealerId][basicOrderId]);
                }
            }
            
            $.ajax({
                url: '@Url.Action("SaveOrders", "DealerOrders")',
                type: 'POST',
                data: formData,
                success: function (result) {
                    if (result.success) {
                        // Trigger custom event to move dealer to successful orders
                        $(document).trigger('orderSaved', [dealerId, dealerName]);
                        
                        // Show success message
                        Swal.fire({
                            icon: 'success',
                            title: 'Success',
                            text: 'Order for ' + dealerName + ' saved successfully!',
                            confirmButtonText: 'OK'
                        });
                    } else {
                        // Show error message
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error saving order for ' + dealerName + ': ' + (result.message || 'Unknown error'),
                            confirmButtonText: 'OK'
                        });
                    }
                },
                error: function (xhr, status, error) {
                    // Show error message
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Error saving order for ' + dealerName + '. Please try again. ' + error,
                        confirmButtonText: 'OK'
                    });
                },
                complete: function() {
                    // Always reset button state when AJAX call completes
                    resetButtonState(button, originalText);
                }
            });
        });
        
        // Custom accordion toggle implementation to avoid conflicts
        $('.accordion-toggle').on('click', function(e) {
            e.preventDefault();
            
            var dealerId = $(this).data('dealer-id');
            var content = $('#collapse' + dealerId);
            var icon = $(this).find('.toggle-icon');
            
            // Toggle the content
            if (content.hasClass('d-none')) {
                // Show content
                content.removeClass('d-none');
                icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
            } else {
                // Hide content
                content.addClass('d-none');
                icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
            }
        });
        
        // Initialize the first accordion as open
        $('.accordion-toggle').first().find('.toggle-icon').removeClass('fa-chevron-down').addClass('fa-chevron-up');
    });
</script>