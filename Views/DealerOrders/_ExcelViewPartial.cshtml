@model Milk_Bakery.ViewModels.DealerOrdersViewModel

<style>
    .excel-view-container {
        font-size: 0.85rem;
    }
    
    .card-header {
        padding: 0.5rem 1rem;
    }
    
    .card-body {
        padding: 0.75rem;
    }
    
    .excel-table-container {
        max-height: 70vh;
        overflow: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.35rem;
    }
    
    .excel-table {
        margin-bottom: 0;
        width: 100%;
        min-width: 800px; /* Ensure minimum width for small screens */
    }
    
    .excel-table th {
        font-weight: 600;
        font-size: 0.8rem;
        padding: 0.4rem 0.3rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .excel-table td {
        padding: 0.3rem;
        vertical-align: middle;
    }
    
    .dealer-col {
        min-width: 120px;
        max-width: 150px;
        position: sticky;
        left: 0;
        z-index: 5;
        background-color: white;
        font-weight: 600;
        box-shadow: 2px 0 2px -1px rgba(0,0,0,0.1);
    }
    
    .material-col {
        min-width: 70px;
        max-width: 90px;
        text-align: center;
    }
    
    .total-col {
        min-width: 80px;
        text-align: center;
        font-weight: 600;
        background-color: #f8f9fa;
    }
    
    .quantity-input {
        width: 100%;
        min-width: 60px;
        padding: 0.2rem 0.3rem;
        font-size: 0.8rem;
        text-align: center;
        border: 1px solid #ced4da;
        border-radius: 0.2rem;
    }
    
    .quantity-input:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    }
    
    .conversion-info {
        font-size: 0.75rem;
        color: #6c757d;
    }
    
    .footer-highlight {
        font-weight: 600;
        background-color: #f8f9fa;
    }
    
    .table-responsive {
        overflow-x: auto;
    }
    
    .btn-compact {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
        margin-right: 0.25rem;
        margin-bottom: 0.25rem;
    }
    
    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        margin-bottom: 0.5rem;
    }
    
    /* Mobile-specific adjustments */
    @@media (max-width: 768px) {
        .excel-view-container {
            font-size: 0.8rem;
        }
        
        .card-header {
            padding: 0.4rem 0.75rem;
        }
        
        .card-body {
            padding: 0.5rem;
        }
        
        .excel-table th, 
        .excel-table td {
            padding: 0.25rem 0.2rem;
        }
        
        .dealer-col {
            min-width: 100px;
            max-width: 120px;
        }
        
        .material-col {
            min-width: 60px;
            max-width: 75px;
        }
        
        .total-col {
            min-width: 70px;
        }
        
        .quantity-input {
            min-width: 50px;
            padding: 0.15rem 0.2rem;
            font-size: 0.75rem;
        }
        
        .btn-compact {
            padding: 0.2rem 0.4rem;
            font-size: 0.75rem;
        }
        
        .action-buttons {
            justify-content: center;
        }
    }
    
    /* Small mobile screens */
    @@media (max-width: 576px) {
        .excel-table-container {
            max-height: 60vh;
        }
        
        .dealer-col {
            min-width: 80px;
            max-width: 100px;
            font-size: 0.75rem;
        }
        
        .material-col {
            min-width: 55px;
            max-width: 65px;
        }
        
        .total-col {
            min-width: 60px;
        }
        
        .quantity-input {
            min-width: 45px;
            padding: 0.1rem 0.15rem;
        }
    }
    
    /* Print styles */
    @@media print {
        .btn, .action-buttons {
            display: none !important;
        }
        
        .excel-table-container {
            max-height: none;
            overflow: visible;
        }
        
        .excel-table {
            min-width: auto;
        }
    }
</style>

<div class="excel-view-container">
    <div class="card shadow-sm">
        <div class="card-header py-2">
            <h6 class="mb-0 font-weight-bold text-primary">Excel View - Dealer Orders</h6>
        </div>
        <div class="card-body p-2">
            @if (Model.Dealers.Any())
            {
                <div class="action-buttons">
                    <button class="btn btn-success btn-sm btn-compact" id="saveAllBtn">
                        <i class="fas fa-save"></i> Save All
                    </button>
                    <button class="btn btn-primary btn-sm btn-compact" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Export
                    </button>
                    <button class="btn btn-info btn-sm btn-compact" onclick="toggleSummary()">
                        <i class="fas fa-chart-bar"></i> Summary
                    </button>
                </div>
                
                <div class="table-responsive">
                    <div class="excel-table-container">
                        <table class="table table-bordered table-sm excel-table">
                            <thead class="thead-light" style="position: sticky; top: 0; z-index: 10;">
                                <tr>
                                    <th class="dealer-col" style="position: sticky; left: 0; z-index: 11; background-color: #e9ecef;">Dealer</th>
                                    @foreach (var material in Model.AvailableMaterials.OrderBy(m => m.sequence))
                                    {
                                        <th class="material-col" title="@material.Materialname">@material.ShortName</th>
                                    }
                                    <th class="total-col">Total Qty</th>
                                    <th class="total-col">Total Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var dealer in Model.Dealers)
                                {
                                    <tr data-dealer-id="@dealer.Id">
                                        <td class="dealer-col" style="position: sticky; left: 0; z-index: 2; background-color: white;" title="@dealer.Name">@dealer.Name</td>
                                        @{
                                            int totalQty = 0;
                                            decimal totalAmount = 0;
                                        }
                                        @foreach (var material in Model.AvailableMaterials.OrderBy(m => m.sequence))
                                        {
                                            // Get the basic order quantity for this dealer and material
                                            int quantity = 0;
                                            decimal rate = material.price; // Use material price as rate
                                            
                                            if (Model.DealerBasicOrders.ContainsKey(dealer.Id))
                                            {
                                                var basicOrder = Model.DealerBasicOrders[dealer.Id]
                                                    .FirstOrDefault(bo => bo.MaterialName == material.Materialname);
                                                if (basicOrder != null)
                                                {
                                                    quantity = basicOrder.Quantity;
                                                    rate = basicOrder.Rate;
                                                }
                                            }
                                            
                                            totalQty += quantity;
                                            totalAmount += quantity * rate;
                                            
                                            // Show editable input field for quantity
                                            <td class="material-col">
                                                <input type="number" 
                                                       class="form-control quantity-input" 
                                                       data-dealer-id="@dealer.Id" 
                                                       data-material-id="@material.Id" 
                                                       data-rate="@rate" 
                                                       data-material-name="@material.Materialname"
                                                       value="@quantity" 
                                                       min="0" 
                                                       step="1">
                                            </td>
                                        }
                                        <td class="total-col total-qty">@totalQty</td>
                                        <td class="total-col total-amount">@totalAmount.ToString("F2")</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot style="position: sticky; bottom: 0; z-index: 10; background-color: white;">
                                <tr class="footer-highlight">
                                    <th class="dealer-col" style="position: sticky; left: 0; z-index: 11; background-color: #e9ecef;">Conversion</th>
                                    @foreach (var material in Model.AvailableMaterials.OrderBy(m => m.sequence))
                                    {
                                        // Get conversion info for this material
                                        var conversionText = "1:N/A";
                                        if (Model.MaterialConversions.ContainsKey(material.Materialname))
                                        {
                                            var conversion = Model.MaterialConversions[material.Materialname];
                                            conversionText = "1:" + conversion.TotalQuantity;
                                        }
                                        <th class="material-col conversion-info" data-material-id="@material.Id">@conversionText</th>
                                    }
                                    <th class="total-col"></th>
                                    <th class="total-col"></th>
                                </tr>
                                <tr class="footer-highlight">
                                    <th class="dealer-col" style="position: sticky; left: 0; z-index: 11; background-color: #e9ecef;">Total Qty</th>
                                    @foreach (var material in Model.AvailableMaterials.OrderBy(m => m.sequence))
                                    {
                                        // Total quantity will be calculated by JavaScript
                                        <th class="material-col total-quantity" data-material-id="@material.Id">0</th>
                                    }
                                    <th class="total-col"></th>
                                    <th class="total-col"></th>
                                </tr>
                                <tr class="footer-highlight">
                                    <th class="dealer-col" style="position: sticky; left: 0; z-index: 11; background-color: #e9ecef;">Total Crates</th>
                                    @foreach (var material in Model.AvailableMaterials.OrderBy(m => m.sequence))
                                    {
                                        // Total crates will be calculated by JavaScript
                                        <th class="material-col total-crates" data-material-id="@material.Id">0</th>
                                    }
                                    <th class="total-col"></th>
                                    <th class="total-col"></th>
                                </tr>
                                <tr class="footer-highlight">
                                    <th class="dealer-col" style="position: sticky; left: 0; z-index: 11; background-color: #e9ecef;">Items to Add</th>
                                    @foreach (var material in Model.AvailableMaterials.OrderBy(m => m.sequence))
                                    {
                                        // Items to add will be calculated by JavaScript
                                        <th class="material-col items-to-add" data-material-id="@material.Id">0</th>
                                    }
                                    <th class="total-col"></th>
                                    <th class="total-col"></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                <!-- Summary Panel (Hidden by Default) -->
                <div id="summaryPanel" class="mt-3 p-2 border rounded bg-light" style="display: none;">
                    <h6 class="font-weight-bold">Order Summary</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Total Dealers:</strong> <span id="totalDealers">@Model.Dealers.Count()</span></p>
                            <p><strong>Total Materials:</strong> <span id="totalMaterials">@Model.AvailableMaterials.Count()</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Last Updated:</strong> <span id="lastUpdated">@DateTime.Now.ToString("MMM dd, yyyy hh:mm tt")</span></p>
                            <p><strong>Total Orders:</strong> <span id="totalOrders">0</span></p>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-warning text-center py-2 px-2 small" role="alert">
                    <i class="fas fa-exclamation-triangle"></i> No dealers found for the selected distributor.
                </div>
            }
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Handle quantity input changes
        $('.quantity-input').on('input', function () {
            var row = $(this).closest('tr');
            var totalQty = 0;
            var totalAmount = 0;
            
            // Calculate totals for this dealer row
            row.find('.quantity-input').each(function () {
                var quantity = parseInt($(this).val()) || 0;
                var rate = parseFloat($(this).data('rate')) || 0;
                totalQty += quantity;
                totalAmount += quantity * rate;
            });
            
            // Update total cells
            row.find('.total-qty').text(totalQty);
            row.find('.total-amount').text(totalAmount.toFixed(2));
            
            // Highlight the row to indicate changes
            row.addClass('table-warning');
            
            // Update footer calculations
            updateFooterCalculations();
            updateSummary();
        });
        
        // Handle save all button click
        $('#saveAllBtn').on('click', function () {
            var allOrders = [];
            var hasChanges = false;
            
            // Check if all "Items to Add" values are 0
            var allItemsToAddZero = true;
            $('.items-to-add').each(function() {
                var itemsToAdd = parseInt($(this).text()) || 0;
                if (itemsToAdd !== 0) {
                    allItemsToAddZero = false;
                    return false; // Break the loop
                }
            });
            
            if (!allItemsToAddZero) {
                showNotification('Cannot save orders. All "Items to Add" values must be 0 to complete crates.', 'error');
                return;
            }
            
            // Collect all dealer orders
            $('tbody tr').each(function () {
                var dealerId = $(this).data('dealer-id');
                var orderItems = [];
                
                // Collect all quantities for this dealer
                $(this).find('.quantity-input').each(function () {
                    var materialId = $(this).data('material-id');
                    var quantity = parseInt($(this).val()) || 0;
                    orderItems.push({
                        MaterialId: materialId,
                        Quantity: quantity
                    });
                    
                    // Check if this field has been modified
                    if (quantity != parseInt($(this).attr('value') || 0)) {
                        hasChanges = true;
                    }
                });
                
                allOrders.push({
                    dealerId: dealerId,
                    orderItems: orderItems
                });
            });
            
            if (!hasChanges) {
                showNotification('No changes to save.', 'warning');
                return;
            }
            
            // Show loading state
            var saveBtn = $('#saveAllBtn');
            var originalText = saveBtn.html();
            saveBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');
            
            // Send all data to server
            $.ajax({
                url: '@Url.Action("SaveAllExcelViewOrders", "DealerOrders")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(allOrders),
                success: function (response) {
                    saveBtn.prop('disabled', false).html(originalText);
                    
                    if (response.success) {
                        // Reset all row highlighting on successful save
                        $('tbody tr').removeClass('table-warning').addClass('table-success');
                        setTimeout(function () {
                            $('tbody tr').removeClass('table-success');
                        }, 2000);
                        
                        // Update the original values of inputs
                        $('.quantity-input').each(function() {
                            $(this).attr('value', $(this).val());
                        });
                        
                        // Show success message
                        showNotification('All orders saved successfully!', 'success');
                    } else {
                        showNotification('Error saving orders: ' + response.message, 'error');
                    }
                },
                error: function (xhr, status, error) {
                    saveBtn.prop('disabled', false).html(originalText);
                    showNotification('Error saving orders. Please try again. ' + error, 'error');
                }
            });
        });
        
        // Function to update all footer calculations
        function updateFooterCalculations() {
            // Get the number of material columns (excluding dealer, total qty, and total amount columns)
            var headerCells = $('thead tr th.material-col');
            var materialCount = headerCells.length;
            
            // For each material column, calculate all footer values
            for (var i = 0; i < materialCount; i++) {
                var totalQuantity = 0;
                
                // Sum quantities for this material across all dealers
                $('tbody tr').each(function () {
                    var input = $(this).find('.quantity-input').eq(i);
                    var quantity = parseInt(input.val()) || 0;
                    totalQuantity += quantity;
                });
                
                // Get conversion info for this material
                var conversionCell = $('tfoot tr:first-child .conversion-info').eq(i);
                var conversionText = conversionCell.text();
                var conversionParts = conversionText.split(':');
                var itemsPerCrate = conversionParts.length > 1 ? parseInt(conversionParts[1]) : 0;
                
                // Calculate total crates
                var totalCrates = 0;
                if (itemsPerCrate > 0) {
                    totalCrates = Math.floor(totalQuantity / itemsPerCrate);
                }
                
                // Calculate items needed to complete crates
                var itemsNeeded = 0;
                if (itemsPerCrate > 0) {
                    itemsNeeded = (itemsPerCrate - (totalQuantity % itemsPerCrate)) % itemsPerCrate;
                }
                
                // Update total quantity display
                var totalQuantityCell = $('tfoot tr:nth-child(2) .total-quantity').eq(i);
                totalQuantityCell.text(totalQuantity);
                
                // Update total crates display
                var totalCratesCell = $('tfoot tr:nth-child(3) .total-crates').eq(i);
                totalCratesCell.text(totalCrates);
                
                // Update items to add display
                var itemsToAddCell = $('tfoot tr:nth-child(4) .items-to-add').eq(i);
                itemsToAddCell.text(itemsNeeded);
                
                // Add color coding for items to add
                if (itemsNeeded > 0) {
                    itemsToAddCell.removeClass('text-success').addClass('text-warning font-weight-bold');
                } else {
                    itemsToAddCell.removeClass('text-warning').addClass('text-success font-weight-bold');
                }
            }
        }
        
        // Function to update summary panel
        function updateSummary() {
            var totalOrders = 0;
            var dealersWithOrders = 0;
            
            $('tbody tr').each(function () {
                var hasOrder = false;
                $(this).find('.quantity-input').each(function () {
                    var quantity = parseInt($(this).val()) || 0;
                    if (quantity > 0) {
                        totalOrders += quantity;
                        hasOrder = true;
                    }
                });
                
                if (hasOrder) {
                    dealersWithOrders++;
                }
            });
            
            $('#totalOrders').text(totalOrders);
        }
        
        // Toggle summary panel
        window.toggleSummary = function() {
            $('#summaryPanel').slideToggle();
        }
        
        // Show notification
        function showNotification(message, type) {
            // Remove any existing notifications
            $('.custom-notification').remove();
            
            var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            var icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            
            var notification = $('<div class="alert ' + alertClass + ' alert-dismissible fade show custom-notification" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 1050; min-width: 250px;">' +
                                '<i class="fas ' + icon + '"></i> ' + message +
                                '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                                '<span aria-hidden="true">&times;</span>' +
                                '</button>' +
                                '</div>');
            
            $('body').append(notification);
            
            // Auto dismiss after 3 seconds
            setTimeout(function() {
                notification.alert('close');
            }, 3000);
        }
        
        // Initialize footer calculations on page load
        updateFooterCalculations();
        updateSummary();
    });
    
    function exportToExcel() {
        // Simple export to CSV functionality
        var table = $('.excel-table')[0];
        var csv = [];
        var rows = table.querySelectorAll('tr');
        
        for (var i = 0; i < rows.length; i++) {
            var row = [], cols = rows[i].querySelectorAll('td, th');
            
            for (var j = 0; j < cols.length; j++) {
                // For quantity input cells, get the input value
                var input = cols[j].querySelector('input');
                var data = input ? input.value : cols[j].innerText;
                data = data.replace(/"/g, '""');
                row.push('"' + data + '"');
            }
            
            csv.push(row.join(','));
        }
        
        var csvString = csv.join('\n');
        var blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        var link = document.createElement('a');
        var url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'dealer_orders_' + new Date().toISOString().slice(0,10) + '.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>