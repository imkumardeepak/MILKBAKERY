@model Milk_Bakery.ViewModels.DeliveredQuantityEntryViewModel

<div class="container-fluid px-0">
    <!-- AddAntiForgeryToken for AJAX requests -->
    @Html.AntiForgeryToken()

    @if (Model.Dealers.Any())
    {
                                            <div class="accordion" id="dealersAccordion">
            @{
                int index = 0;
            }
            @foreach (var dealer in Model.Dealers)
            {
                                                                                        <div class="card shadow-sm mb-2 border-left-primary">
                                                                                            <div class="card-header py-2 px-3 d-flex justify-content-between align-items-center"
                                                                                                id="heading@(dealer.Id)">
                                                                                                <h6 class="mb-0 font-weight-bold text-primary">@dealer.Name</h6>
                                                                                                <button class="btn btn-link text-primary p-1 accordion-toggle" type="button"
                                                                                                    data-dealer-id="@dealer.Id">
                                                                                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                                                                                </button>
                                                                                            </div>

                                                                                            <div id="collapse@(dealer.Id)" class="dealer-collapse-content @(index == 0 ? "" : "d-none")">
                                                                                                <div class="card-body p-2">
                                                                                                    <h6 class="font-weight-bold text-primary mb-2 small">Orders</h6>
                            @if (Model.DealerOrders.ContainsKey(dealer.Id) && Model.DealerOrders[dealer.Id].Any())
                            {
                                // Check if any order is not processed
                                var hasUnprocessedOrder = Model.DealerOrders[dealer.Id].Any(o => o.ProcessFlag != 1);
                                if (hasUnprocessedOrder)
                                {
                                                                                                                                                                                    <div class="alert alert-warning py-2 px-2 mb-2 small" role="alert">
                                                                                                                                                                                        <i class="fas fa-exclamation-triangle"></i> This order has not been processed yet and cannot have delivered quantities entered. Please wait until the order is consolidated.
                                                                                                                                                                                    </div>
                                }
                                else
                                {
                                    // Calculate dealer totals
                                    var dealerTotalOrdered = 0;
                                    var dealerTotalDelivered = 0;
                                    var dealerTotalAmountVariance = 0m;

                                    foreach (var order in Model.DealerOrders[dealer.Id])
                                    {
                                        foreach (var item in order.DealerOrderItems)
                                        {
                                            dealerTotalOrdered += item.Qty;
                                            dealerTotalDelivered += item.DeliverQnty;
                                            var orderedAmount = item.Qty * item.Rate;
                                            var deliveredAmount = item.DeliverQnty * item.Rate;
                                            dealerTotalAmountVariance += (orderedAmount - deliveredAmount);
                                        }
                                    }

                                            // Display dealer summary
                                                                                                                                                                                    <div class="alert alert-info py-2 px-2 mb-2 small" role="alert">
                                                                                                                                                                                        <div class="row text-center">
                                                                                                                                                                                            <div class="col-4 pr-1 border-right">
                                                                                                                                                                                                <div class="font-weight-bold">Ordered</div>
                                                                                                                                                                                                <div class="h6 mb-0">@dealerTotalOrdered</div>
                                                                                                                                                                                            </div>
                                                                                                                                                                                            <div class="col-4 px-1 border-right">
                                                                                                                                                                                                <div class="font-weight-bold">Delivered</div>
                                                                                                                                                                                                <div class="h6 mb-0">@dealerTotalDelivered</div>
                                                                                                                                                                                            </div>
                                                                                                                                                                                            <div class="col-4 pl-1">
                                                                                                                                                                                                <div class="font-weight-bold">Variance</div>
                                                                                                                                                                                                <div class="h6 mb-0 @(dealerTotalAmountVariance == 0 ? "text-success" : dealerTotalAmountVariance > 0 ? "text-warning" : "text-danger")">
                                                                                                                                                                                                    ₹@dealerTotalAmountVariance.ToString("F0")
                                                                                                                                                                                                </div>
                                                                                                                                                                                            </div>
                                                                                                                                                                                        </div>
                                                                                                                                                                                    </div>

                                    @foreach (var order in Model.DealerOrders[dealer.Id])
                                    {
                                                                                                                                                                                                                            <div class="card mb-2 shadow-sm">
                                                                                                                                                                                                                                <div class="card-body p-2">
                                                                                                                                                                                                                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                                                                                                                                                                                                                        <div class="small">
                                                                                                                                                                                                                                            <span class="badge badge-secondary">#@order.Id</span>
                                                                                                                                                                                                                                            <span class="ml-1">@order.OrderDate.ToString("dd/MM/yyyy")</span>
                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                        <button class="btn btn-success btn-sm save-delivery-btn" data-order-id="@order.Id">
                                                                                                                                                                                                                                            <i class="fas fa-save"></i> <span class="d-none d-sm-inline">Save</span>
                                                                                                                                                                                                                                        </button>
                                                                                                                                                                                                                                    </div>

                                                @if (order.DealerOrderItems.Any())
                                                {
                                                                                                                                                                                                                                                                            <div class="table-responsive">
                                                                                                                                                                                                                                                                                <table class="table table-bordered table-hover table-sm mb-0 delivery-table small"
                                                                                                                                                                                                                                                                                    data-order-id="@order.Id">
                                                                                                                                                                                                                                                                                    <thead class="thead-dark">
                                                                                                                                                                                                                                                                                        <tr>
                                                                                                                                                                                                                                                                                            <th class="p-1 d-none d-md-table-cell">Material</th>
                                                                                                                                                                                                                                                                                            <th class="p-1">Code</th>
                                                                                                                                                                                                                                                                                            <th class="p-1 text-center">Ordered Qty</th>
                                                                                                                                                                                                                                                                                            <th class="p-1 text-center">Delivered Qty</th>
                                                                                                                                                                                                                                                                                            <th class="p-1 text-center">Ordered Amt</th>
                                                                                                                                                                                                                                                                                            <th class="p-1 text-center">Delivered Amt</th>
                                                                                                                                                                                                                                                                                            <th class="p-1 text-center">Qty Variance</th>
                                                                                                                                                                                                                                                                                            <th class="p-1 text-center">Amount Variance</th>
                                                                                                                                                                                                                                                                                        </tr>
                                                                                                                                                                                                                                                                                    </thead>
                                                                                                                                                                                                                                                                                    <tbody>
                                                                @foreach (var item in order.DealerOrderItems)
                                                                {
                                                                    var orderedAmount = item.Qty * item.Rate;
                                                                    var deliveredAmount = item.DeliverQnty * item.Rate;
                                                                    var amountVariance = orderedAmount - deliveredAmount;
                                                                    var variance = item.Qty - item.DeliverQnty;
                                                                                                                                                                                                                                                                                                                                <tr data-item-id="@item.Id" data-unit-price="@item.Rate">
                                                                                                                                                                                                                                                                                                                                    <td class="p-1 d-none d-md-table-cell">@item.MaterialName</td>
                                                                                                                                                                                                                                                                                                                                    <td class="p-1"><strong>@item.ShortCode</strong></td>
                                                                                                                                                                                                                                                                                                                                    <td class="p-1 text-center ordered-qty"><strong>@item.Qty</strong></td>
                                                                                                                                                                                                                                                                                                                                    <td class="p-1 text-center delivered-qty-cell">
                                                                                                                                                                                                                                                                                                                                        <div class="input-group input-group-sm">
                                                                                                                                                                                                                                                                                                                                            <button class="btn btn-outline-secondary qty-decrease btn-sm p-1" type="button" data-item-id="@item.Id">-</button>
                                                                                                                                                                                                                                                                                                                                            <input type="number"
                                                                                                                                                                                                                                                                                                                                                    class="form-control form-control-sm delivered-qty text-center p-1"
                                                                                                                                                                                                                                                                                                                                                    data-item-id="@item.Id" value="@item.Qty" min="0" step="1"
                                                                                                                                                                                                                                                                                                                                                    style="width: 50px; height: 30px; font-size: 0.8rem;" />
                                                                                                                                                                                                                                                                                                                                            <button class="btn btn-outline-secondary qty-increase btn-sm p-1" type="button" data-item-id="@item.Id">+</button>
                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                    </td>
                                                                                                                                                                                                                                                                                                                                    <td class="p-1 text-center ordered-amount"></td>
                                                                                                                                                                                                                                                                                                                                    <td class="p-1 text-center delivered-amount"></td>
                                                                                                                                                                                                                                                                                                                                    <td class="p-1 text-center quantity-variance"></td>
                                                                                                                                                                                                                                                                                                                                    <td class="p-1 text-center amount-variance"></td>
                                                                                                                                                                                                                                                                                                                                </tr>
                                                                }
                                                                                                                                                                                                                                                                                    </tbody>
                                                                                                                                                                                                                                                                                </table>
                                                                                                                                                                                                                                                                            </div>
                                                }
                                                else
                                                {
                                                                                                                                                                                                                                                                            <div class="alert alert-info py-1 px-2 mb-0 small" role="alert">
                                                                                                                                                                                                                                                                                <i class="fas fa-info-circle"></i> No items found
                                                                                                                                                                                                                                                                            </div>
                                                }
                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                            </div>
                                    }
                                }
                            }
                            else
                            {
                                                                                                                                            <div class="alert alert-info py-1 px-2 mb-2 small" role="alert">
                                                                                                                                                <i class="fas fa-info-circle"></i> No orders found
                                                                                                                                            </div>
                            }
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                index++;
            }
                                            </div>
    }
    else
    {
                                            <div class="alert alert-warning text-center small py-2" role="alert">
                                                <i class="fas fa-exclamation-triangle"></i> No dealers found
                                            </div>
    }
</div>

<script>
    $(document).ready(function () {
        // Custom accordion toggle implementation to avoid conflicts
        $('.accordion-toggle').on('click', function (e) {
            e.preventDefault();

            var dealerId = $(this).data('dealer-id');
            var content = $('#collapse' + dealerId);
            var icon = $(this).find('.toggle-icon');

            // Toggle the content
            if (content.hasClass('d-none')) {
                // Show content
                content.removeClass('d-none');
                icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
            } else {
                // Hide content
                content.addClass('d-none');
                icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
            }
        });

        // Initialize the first accordion as open
        $('.accordion-toggle').first().find('.toggle-icon').removeClass('fa-chevron-down').addClass('fa-chevron-up');

        // Function to calculate and update row values
        function updateRowValues(row) {
            var orderedQty = parseInt(row.find('.ordered-qty').text()) || 0;
            var deliveredQty = parseInt(row.find('.delivered-qty').val()) || 0;
            var unitPrice = parseFloat(row.data('unit-price')) || 0;

            var orderedAmount = orderedQty * unitPrice;
            var deliveredAmount = deliveredQty * unitPrice;
            var quantityVariance = deliveredQty - orderedQty;
            var amountVariance = deliveredAmount - orderedAmount;

            row.find('.ordered-amount').text('₹' + orderedAmount.toFixed(2));
            row.find('.delivered-amount').text('₹' + deliveredAmount.toFixed(2));

            var quantityVarianceElement = row.find('.quantity-variance');
            quantityVarianceElement.text((quantityVariance > 0 ? '+' : '') + quantityVariance);
            quantityVarianceElement.removeClass('text-secondary text-success text-danger');
            if (quantityVariance === 0) {
                quantityVarianceElement.addClass('text-secondary');
            } else if (quantityVariance > 0) {
                quantityVarianceElement.addClass('text-success');
            } else {
                quantityVarianceElement.addClass('text-danger');
            }

            var amountVarianceElement = row.find('.amount-variance');
            amountVarianceElement.text('₹' + (amountVariance > 0 ? '+' : '') + amountVariance.toFixed(2));
            amountVarianceElement.removeClass('text-secondary text-success text-danger');
            if (amountVariance === 0) {
                amountVarianceElement.addClass('text-secondary');
            } else if (amountVariance > 0) {
                amountVarianceElement.addClass('text-success');
            } else {
                amountVarianceElement.addClass('text-danger');
            }
        }

        // Function to update dealer summary totals
        function updateDealerSummary(dealerId) {
            var dealerContainer = $('#collapse' + dealerId);
            var totalOrderedQty = 0;
            var totalDeliveredQty = 0;
            var totalOrderedAmount = 0;
            var totalDeliveredAmount = 0;

            dealerContainer.find('.delivery-table tbody tr').each(function () {
                var orderedQty = parseInt($(this).find('.ordered-qty').text()) || 0;
                var deliveredQty = parseInt($(this).find('.delivered-qty').val()) || 0;
                var unitPrice = parseFloat($(this).data('unit-price')) || 0;

                totalOrderedQty += orderedQty;
                totalDeliveredQty += deliveredQty;
                totalOrderedAmount += (orderedQty * unitPrice);
                totalDeliveredAmount += (deliveredQty * unitPrice);
            });

            var quantityVariance = totalDeliveredQty - totalOrderedQty;
            var amountVariance = totalDeliveredAmount - totalOrderedAmount;

            var summaryContainer = dealerContainer.find('.alert-info').first();
            summaryContainer.find('.col-4').eq(0).html('<div class="font-weight-bold">Ordered Qty</div><div class="h6 mb-0">' + totalOrderedQty + '</div>');
            summaryContainer.find('.col-4').eq(1).html('<div class="font-weight-bold">Delivered Qty</div><div class="h6 mb-0">' + totalDeliveredQty + '</div>');

            var varianceElement = summaryContainer.find('.col-4').eq(2).find('div').eq(1);
            varianceElement.html((quantityVariance > 0 ? '+' : '') + quantityVariance + ' / ₹' + (amountVariance > 0 ? '+' : '') + amountVariance.toFixed(0));
            varianceElement.removeClass('text-secondary text-success text-danger');
            if (quantityVariance === 0 && amountVariance === 0) {
                varianceElement.addClass('text-secondary');
            } else if (quantityVariance > 0 || amountVariance > 0) {
                varianceElement.addClass('text-success');
            } else {
                varianceElement.addClass('text-danger');
            }
        }

        // Initialize delivered amounts for all rows on page load
        $('.delivery-table tbody tr').each(function () {
            // Set the input value to the delivered quantity
            var deliveredQty = parseInt($(this).find('.delivered-qty').val()) || 0;
            $(this).find('.delivered-qty').val(deliveredQty);
            updateRowValues($(this));
        });

        // Initialize dealer summaries
        $('.dealer-collapse-content').each(function () {
            var dealerId = $(this).attr('id').replace('collapse', '');
            updateDealerSummary(dealerId);
        });

        // Handle delivered quantity changes
        $(document).on('input', '.delivered-qty', function () {
            var row = $(this).closest('tr');
            updateRowValues(row);

            // Update the dealer summary
            var dealerId = $(this).closest('.dealer-collapse-content').attr('id').replace('collapse', '');
            updateDealerSummary(dealerId);
        });

        // Handle quantity increase button
        $(document).on('click', '.qty-increase', function() {
            var inputField = $(this).closest('.input-group').find('.delivered-qty');
            var currentValue = parseInt(inputField.val()) || 0;
            inputField.val(currentValue + 1).trigger('input');
        });

        // Handle quantity decrease button
        $(document).on('click', '.qty-decrease', function() {
            var inputField = $(this).closest('.input-group').find('.delivered-qty');
            var currentValue = parseInt(inputField.val()) || 0;
            if (currentValue > 0) {
                inputField.val(currentValue - 1).trigger('input');
            }
        });

        // Handle save button click
        $('.save-delivery-btn').on('click', function () {
            var button = $(this);
            var originalText = button.html();
            var orderId = button.data('order-id');
            var table = button.closest('.card').find('.delivery-table');

            // Show loading indicator
            button.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');
            button.prop('disabled', true);

            // Prepare form data
            var items = [];

            table.find('tbody tr').each(function () {
                var itemId = $(this).data('item-id');
                var quantity = parseInt($(this).find('.delivered-qty').val()) || 0;
                items.push({
                    itemId: itemId,
                    deliveredQuantity: quantity
                });
            });

            var saveData = {
                orderId: orderId,
                items: items
            };

            // Send AJAX request
            $.ajax({
                url: '@Url.Action("Save", "DeliveredQuantity")',
                type: 'POST',
                data: JSON.stringify(saveData),
                contentType: 'application/json; charset=utf-8',
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (result) {
                    if (result.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Saved!',
                            text: 'Delivered quantities saved successfully!',
                            confirmButtonText: 'OK',
                            timer: 1500,
                            timerProgressBar: true,
                            showConfirmButton: false
                        }).then((result) => {
                            // Reload the page after successful save
                            location.reload();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: result.message || 'Error saving delivered quantities. Please try again.',
                            confirmButtonText: 'OK'
                        });
                    }
                },
                error: function (xhr, status, error) {
                    var errorMessage = 'Error saving delivered quantities. Please try again.';

                    // Try to parse the response for a more detailed error message
                    if (xhr.responseText) {
                        try {
                            var response = JSON.parse(xhr.responseText);
                            if (response.message) {
                                errorMessage = response.message;
                            }
                        } catch (e) {
                            // If parsing fails, use the raw response text if it's not too long
                            if (xhr.responseText.length < 200) {
                                errorMessage = xhr.responseText;
                            }
                        }
                    }

                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: errorMessage,
                        confirmButtonText: 'OK'
                    });
                },
                complete: function () {
                    // Reset button state
                    button.html(originalText);
                    button.prop('disabled', false);
                }
            });
        });
    });
</script>

    <style>
        .cursor-pointer {
            cursor: pointer;
        }

        /* Compact design for mobile */
        @@media (max-width: 767.98px) {
            .card-body {
                padding: 0.5rem !important;
            }

            .p-2 {
                padding: 0.5rem !important;
            }

            .py-2 {
                padding-top: 0.5rem !important;
                padding-bottom: 0.5rem !important;
            }

            .px-2 {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }

            .mb-2 {
                margin-bottom: 0.5rem !important;
            }

            .table th, .table td {
                padding: 0.25rem !important;
                font-size: 0.75rem;
            }

            .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }

            .input-group-sm .btn {
                padding: 0.15rem 0.25rem;
                font-size: 0.75rem;
            }

            .input-group-sm .form-control {
                height: 25px;
                font-size: 0.75rem;
            }

            .small {
                font-size: 0.75rem;
            }
        }

        /* Material name column styling */
        .d-none.d-md-table-cell {
            min-width: 150px;
            font-size: 0.85rem;
        }

        /* Variance column styling */
        .variance, .amount-variance {
            font-size: 0.8rem;
        }

        /* Save button responsive text */
        @@media (max-width: 575.98px) {
            .save-delivery-btn .d-none.d-sm-inline {
                display: none !important;
            }
        }

        /* Border styling for summary */
        .border-right {
            border-right: 1px solid #dee2e6 !important;
        }

        /* Accordion toggle icon */
        .toggle-icon {
            font-size: 0.9rem;
        }
    </style>
</div>
