@model Milk_Bakery.ViewModels.DeliveredQuantityEntryViewModel

<div class="container-fluid px-0">
    <!-- AddAntiForgeryToken for AJAX requests -->
    @Html.AntiForgeryToken()

    @if (Model.Dealers.Any())
    {
        <div class="accordion" id="dealersAccordion">
            @{
                int index = 0;
            }
            @foreach (var dealer in Model.Dealers)
            {
                <div class="card shadow-sm mb-2 border-left-primary">
                    <div class="card-header py-2 px-3 d-flex justify-content-between align-items-center"
                        id="heading@(dealer.Id)">
                        <h6 class="mb-0 font-weight-bold text-primary small">@dealer.Name</h6>
                        <button class="btn btn-link text-primary p-1 accordion-toggle" type="button"
                            data-dealer-id="@dealer.Id">
                            <i class="fas fa-chevron-down toggle-icon small"></i>
                        </button>
                    </div>

                    <div id="collapse@(dealer.Id)" class="dealer-collapse-content @(index == 0 ? "" : "d-none")">
                        <div class="card-body p-2">
                            <h6 class="font-weight-bold text-primary mb-2 small">Orders</h6>
                            @if (Model.DealerOrders.ContainsKey(dealer.Id) && Model.DealerOrders[dealer.Id].Any())
                            {
                                // Check if any order is not processed
                                var hasUnprocessedOrder = Model.DealerOrders[dealer.Id].Any(o => o.ProcessFlag != 1);
                                if (hasUnprocessedOrder)
                                {
                                    <div class="alert alert-warning py-2 px-2 mb-2 small" role="alert">
                                        <i class="fas fa-exclamation-triangle"></i> This order has not been processed yet and cannot have delivered quantities entered. Please wait until the order is consolidated.
                                    </div>
                                }
                                else
                                {
                                    // Calculate dealer totals
                                    var dealerTotalOrdered = 0 ;
                                    var dealerTotalDelivered = 0;
                                    var dealerTotalAmountVariance = 0m;

                                    foreach (var order in Model.DealerOrders[dealer.Id])
                                    {
                                        foreach (var item in order.DealerOrderItems)
                                        {
                                            dealerTotalOrdered += item.Qty;
                                            dealerTotalDelivered += item.DeliverQnty;
                                            var orderedAmount = item.Qty * item.Rate;
                                            var deliveredAmount = item.DeliverQnty * item.Rate;
                                            dealerTotalAmountVariance += (orderedAmount - deliveredAmount);
                                        }
                                    }

                                    // Display dealer summary
                                    <div class="alert alert-info py-2 px-2 mb-2 small" role="alert">
                                        <div class="row">
                                            <div class="col-4 pr-1">
                                                <strong>Ordered:</strong> @dealerTotalOrdered
                                            </div>
                                            <div class="col-4 px-1">
                                                <strong>Delivered:</strong> @dealerTotalDelivered
                                            </div>
                                            <div class="col-4 pl-1">
                                                <strong>Variance:</strong>
                                                <span
                                                    class="@(dealerTotalAmountVariance == 0 ? "text-success" : dealerTotalAmountVariance > 0 ? "text-warning" : "text-danger")">
                                                    <strong>₹@dealerTotalAmountVariance.ToString("F0")</strong>
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    @foreach (var order in Model.DealerOrders[dealer.Id])
                                    {
                                        <div class="card mb-2 shadow-sm">
                                            <div class="card-body p-2">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <div class="small">
                                                        <strong>ID:</strong> @order.Id
                                                        <br />
                                                        <strong>Date:</strong> @order.OrderDate.ToString("dd/MM/yyyy")
                                                    </div>
                                                    <button class="btn btn-success btn-sm save-delivery-btn" data-order-id="@order.Id">
                                                        <i class="fas fa-save"></i> <span class="d-none d-sm-inline">Save</span>
                                                    </button>
                                                </div>

                                                @if (order.DealerOrderItems.Any())
                                                {
                                                    <div class="table-responsive">
                                                        <table class="table table-bordered table-hover table-sm mb-0 delivery-table small"
                                                            data-order-id="@order.Id">
                                                            <thead class="thead-dark">
                                                                <tr>
                                                                    <!-- Material name column hidden on small screens, visible on medium and up -->
                                                                    <th class="p-1 d-none d-md-table-cell">Material</th>
                                                                    <th class="p-1">Code</th>
                                                                    <th class="p-1 text-center">Ordered</th>
                                                                    <th class="p-1 text-center">Delivered</th>
                                                                    <th class="p-1 text-center">Qty Variance</th>
                                                                    <th class="p-1 text-center">Amount Variance</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                @foreach (var item in order.DealerOrderItems)
                                                                {
                                                                    var orderedAmount = item.Qty * item.Rate;
                                                                    var deliveredAmount = item.DeliverQnty * item.Rate;
                                                                    var amountVariance = orderedAmount - deliveredAmount;
                                                                    var variance = item.Qty - item.DeliverQnty;
                                                                    <tr data-item-id="@item.Id" data-unit-price="@item.Rate">
                                                                        <!-- Material name cell hidden on small screens, visible on medium and up -->
                                                                        <td class="p-1 d-none d-md-table-cell">@item.MaterialName</td>
                                                                        <td class="p-1"><strong>@item.ShortCode</strong></td>
                                                                        <td class="p-1 text-center ordered-qty"><strong>@item.Qty</strong></td>
                                                                        <td class="p-1 text-center">
                                                                            <div class="input-group input-group-sm">
                                                                                <div class="input-group-prepend">
                                                                                    <button class="btn btn-outline-secondary qty-decrease p-1" type="button" data-item-id="@item.Id">
                                                                                        <i class="fas fa-minus"></i>
                                                                                    </button>
                                                                                </div>
                                                                                <input type="number"
                                                                                    class="form-control form-control-sm delivered-qty text-center p-1"
                                                                                    data-item-id="@item.Id" value="@item.Qty" min="0" step="1"
                                                                                    style="width: 60px; height: 30px; font-size: 0.8rem;" />
                                                                                <div class="input-group-append">
                                                                                    <button class="btn btn-outline-secondary qty-increase p-1" type="button" data-item-id="@item.Id">
                                                                                        <i class="fas fa-plus"></i>
                                                                                    </button>
                                                                                </div>
                                                                            </div>
                                                                        </td>
                                                                        <td class="p-1 text-center variance @(variance == 0 ? "text-success" : variance > 0 ? "text-danger" : "text-warning")">
                                                                            <strong><span class="variance-value">@(@variance > 0 ? "+" + variance : variance.ToString())</span></strong>
                                                                        </td>
                                                                        <td class="p-1 text-center amount-variance @(amountVariance == 0 ? "text-success" : amountVariance > 0 ? "text-danger" : "text-warning")">
                                                                            <strong><span class="amount-variance-value">@(@amountVariance > 0 ? "+" + amountVariance.ToString("F2") : amountVariance.ToString("F2"))</span></strong>
                                                                        </td>
                                                                    </tr>
                                                                }
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="alert alert-info py-1 px-2 mb-0 small" role="alert">
                                                        <i class="fas fa-info-circle"></i> No items found
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    }
                                }
                            }
                            else
                            {
                                <div class="alert alert-info py-1 px-2 mb-2 small" role="alert">
                                    <i class="fas fa-info-circle"></i> No orders found
                                </div>
                            }
                        </div>
                    </div>
                </div>
                index++;
            }
        </div>
    }
    else
    {
        <div class="alert alert-warning text-center small py-2" role="alert">
            <i class="fas fa-exclamation-triangle"></i> No dealers found
        </div>
    }
</div>

<script>
    $(document).ready(function () {
        // Remove any existing event handlers to prevent duplication
        $(document).off('click', '.qty-increase');
        $(document).off('click', '.qty-decrease');
        $(document).off('input', '.delivered-qty');
        $('.save-delivery-btn').off('click');
        $('.accordion-toggle').off('click');
        
        // Custom accordion toggle implementation to avoid conflicts
        $('.accordion-toggle').on('click', function (e) {
            e.preventDefault();

            var dealerId = $(this).data('dealer-id');
            var content = $('#collapse' + dealerId);
            var icon = $(this).find('.toggle-icon');

            // Toggle the content
            if (content.hasClass('d-none')) {
                // Show content
                content.removeClass('d-none');
                icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
            } else {
                // Hide content
                content.addClass('d-none');
                icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
            }
        });

        // Initialize the first accordion as open
        $('.accordion-toggle').first().find('.toggle-icon').removeClass('fa-chevron-down').addClass('fa-chevron-up');

        // Function to calculate and update row values
        function updateRowValues(row) {
            var unitPrice = parseFloat(row.data('unit-price'));
            var deliveredQty = parseInt(row.find('.delivered-qty').val()) || 0;
            var orderedQty = parseInt(row.find('.ordered-qty').text()) || 0;

            // Validate input - cannot be negative
            if (deliveredQty < 0) {
                row.find('.delivered-qty').addClass('is-invalid');
                return;
            } else {
                row.find('.delivered-qty').removeClass('is-invalid');
            }

            // Calculate amounts
            var deliveredAmount = (deliveredQty * unitPrice);
            var variance = deliveredQty - orderedQty;  // Fixed: deliver qty - order qty = variance
            var orderedAmount = orderedQty * unitPrice;
            var amountVariance = deliveredAmount - orderedAmount; // Changed to show positive when increasing, negative when decreasing

            // Update row values
            row.find('.variance-value').text(variance > 0 ? '+' + variance : variance);
            row.find('.amount-variance-value').text(amountVariance > 0 ? '+' + amountVariance.toFixed(2) : amountVariance.toFixed(2));

            // Apply color coding to quantity variance
            var varianceCell = row.find('.variance');
            if (variance === 0) {
                // Fully delivered - green
                varianceCell.removeClass('text-warning text-danger').addClass('text-success');
            } else if (variance > 0) {
                // Over delivery - red (positive variance)
                varianceCell.removeClass('text-success text-warning').addClass('text-danger');
            } else {
                // Under delivery - orange (negative variance)
                varianceCell.removeClass('text-success text-danger').addClass('text-warning');
            }

            // Apply color coding to amount variance
            var amountVarianceCell = row.find('.amount-variance');
            if (amountVariance === 0) {
                // No amount variance - green
                amountVarianceCell.removeClass('text-warning text-danger').addClass('text-success');
            } else if (amountVariance > 0) {
                // Positive amount variance (gain) - red
                amountVarianceCell.removeClass('text-success text-warning').addClass('text-danger');
            } else {
                // Negative amount variance (loss) - orange
                amountVarianceCell.removeClass('text-success text-danger').addClass('text-warning');
            }
        }

        // Function to update dealer summary totals
        function updateDealerSummary(dealerId) {
            var dealerContainer = $('#collapse' + dealerId);
            var totalOrdered = 0;
            var totalDelivered = 0;
            var totalAmountVariance = 0;

            // Calculate totals for all orders of this dealer
            dealerContainer.find('.delivery-table tbody tr').each(function () {
                var orderedQty = parseInt($(this).find('.ordered-qty').text()) || 0;
                var deliveredQty = parseInt($(this).find('.delivered-qty').val()) || 0;
                var unitPrice = parseFloat($(this).data('unit-price')) || 0;

                totalOrdered += orderedQty;
                totalDelivered += deliveredQty;

                var orderedAmount = orderedQty * unitPrice;
                var deliveredAmount = deliveredQty * unitPrice;
                var amountVariance = deliveredAmount - orderedAmount; // Changed to show positive when increasing, negative when decreasing
                totalAmountVariance += amountVariance;
            });

            // Update the summary display
            var summaryContainer = dealerContainer.find('.alert-info').first();
            summaryContainer.find('.col-4').eq(0).html('<strong>Ordered:</strong> ' + totalOrdered);
            summaryContainer.find('.col-4').eq(1).html('<strong>Delivered:</strong> ' + totalDelivered);

            var amountVarianceElement = summaryContainer.find('.col-4').eq(2).find('span');
            amountVarianceElement.html('<strong>₹' + (totalAmountVariance > 0 ? '+' : '') + totalAmountVariance.toFixed(0) + '</strong>');

            // Apply color coding to amount variance
            if (totalAmountVariance === 0) {
                amountVarianceElement.removeClass('text-warning text-danger').addClass('text-success');
            } else if (totalAmountVariance > 0) {
                // Positive amount variance (gain) - red
                amountVarianceElement.removeClass('text-success text-warning').addClass('text-danger');
            } else {
                // Negative amount variance (loss) - orange
                amountVarianceElement.removeClass('text-success text-danger').addClass('text-warning');
            }
        }

        // Initialize delivered amounts for all rows on page load
        $('.delivery-table tbody tr').each(function () {
            // Set the input value to the ordered quantity by default
            var orderedQty = parseInt($(this).find('.ordered-qty').text()) || 0;
            $(this).find('.delivered-qty').val(orderedQty);
            updateRowValues($(this));
        });

        // Initialize dealer summaries
        $('.dealer-collapse-content').each(function () {
            var dealerId = $(this).attr('id').replace('collapse', '');
            updateDealerSummary(dealerId);
        });

        // Handle delivered quantity changes
        $(document).on('input', '.delivered-qty', function () {
            var row = $(this).closest('tr');
            updateRowValues(row);

            // Update the dealer summary
            var dealerId = $(this).closest('.dealer-collapse-content').attr('id').replace('collapse', '');
            updateDealerSummary(dealerId);
        });

        // Handle quantity increase button
        $(document).on('click', '.qty-increase', function() {
            var inputField = $(this).closest('.input-group').find('.delivered-qty');
            var currentValue = parseInt(inputField.val()) || 0;
            inputField.val(currentValue + 1).trigger('input');
            
            // Add visual feedback
            $(this).addClass('btn-success');
            setTimeout(() => {
                $(this).removeClass('btn-success');
            }, 150);
        });
        
        // Handle quantity decrease button
        $(document).on('click', '.qty-decrease', function() {
            var inputField = $(this).closest('.input-group').find('.delivered-qty');
            var currentValue = parseInt(inputField.val()) || 0;
            if (currentValue > 0) {
                inputField.val(currentValue - 1).trigger('input');
                
                // Add visual feedback
                $(this).addClass('btn-danger');
                setTimeout(() => {
                    $(this).removeClass('btn-danger');
                }, 150);
            }
        });

        // Handle save button click
        $('.save-delivery-btn').on('click', function () {
            var button = $(this);
            var originalText = button.html();
            var orderId = button.data('order-id');
            var table = button.closest('.card').find('.delivery-table');

            // Show loading indicator
            button.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');
            button.prop('disabled', true);

            // Prepare form data
            var items = [];

            table.find('tbody tr').each(function () {
                var itemId = $(this).data('item-id');
                var quantity = parseInt($(this).find('.delivered-qty').val()) || 0;
                items.push({
                    itemId: itemId,
                    deliveredQuantity: quantity
                });
            });

            var saveData = {
                orderId: orderId,
                items: items
            };

            // Send AJAX request
            $.ajax({
                url: '@Url.Action("Save", "DeliveredQuantity")',
                type: 'POST',
                data: JSON.stringify(saveData),
                contentType: 'application/json; charset=utf-8',
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (result) {
                    if (result.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Saved!',
                            text: 'Delivered quantities saved successfully!',
                            confirmButtonText: 'OK',
                            timer: 1500,
                            timerProgressBar: true,
                            showConfirmButton: false
                        }).then((result) => {
                            // Reload the page after successful save
                            location.reload();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: result.message || 'Error saving delivered quantities. Please try again.',
                            confirmButtonText: 'OK'
                        });
                    }
                },
                error: function (xhr, status, error) {
                    var errorMessage = 'Error saving delivered quantities. Please try again.';

                    // Try to parse the response for a more detailed error message
                    if (xhr.responseText) {
                        try {
                            var response = JSON.parse(xhr.responseText);
                            if (response.message) {
                                errorMessage = response.message;
                            }
                        } catch (e) {
                            // If parsing fails, use the raw response text if it's not too long
                            if (xhr.responseText.length < 200) {
                                errorMessage = xhr.responseText;
                            }
                        }
                    }

                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: errorMessage,
                        confirmButtonText: 'OK'
                    });
                },
                complete: function () {
                    // Reset button state
                    button.html(originalText);
                    button.prop('disabled', false);
                }
            });
        });
    });
</script>

<style>
    /* Compact styling for mobile */
    @@media (max-width: 575.98px) {
        .card-body {
            padding: 0.5rem !important;
        }
        
        .form-group {
            margin-bottom: 0.75rem;
        }
        
        .mb-2 {
            margin-bottom: 0.5rem !important;
        }
        
        .p-2 {
            padding: 0.5rem !important;
        }
        
        .table th, .table td {
            padding: 0.25rem !important;
            font-size: 0.75rem;
        }
        
        .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .input-group .btn {
            padding: 0.1rem 0.25rem;
            font-size: 0.7rem;
        }
        
        .form-control {
            padding: 0.1rem 0.25rem;
            font-size: 0.75rem;
            height: calc(1.5em + 0.2rem + 2px);
        }
        
        .small, small {
            font-size: 0.7rem !important;
        }
    }
    
    /* Additional compact styles for very small screens */
    @@media (max-width: 375px) {
        .table th, .table td {
            padding: 0.15rem !important;
            font-size: 0.7rem;
        }
        
        .btn {
            padding: 0.15rem 0.35rem;
            font-size: 0.65rem;
        }
        
        .input-group .btn {
            padding: 0.05rem 0.2rem;
            font-size: 0.6rem;
        }
        
        .form-control {
            padding: 0.05rem 0.2rem;
            font-size: 0.65rem;
            height: calc(1.5em + 0.1rem + 2px);
        }
    }
    
    /* Button feedback styles */
    .btn-success-temp {
        background-color: #28a745 !important;
        border-color: #28a745 !important;
    }
    
    .btn-danger-temp {
        background-color: #dc3545 !important;
        border-color: #dc3545 !important;
    }
</style>