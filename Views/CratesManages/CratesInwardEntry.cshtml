@{
    ViewData["Title"] = "Inward Entry";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .table-fixed-header {
        position: relative;
    }

    .table-fixed-header thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #343a40;
        color: white;
    }

    .table-fixed-header th {
        position: sticky;
        top: 0;
    }

    /* Ensure input fields have consistent height */
    .form-control-sm {
        height: calc(1.5em + 0.5rem + 2px);
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        line-height: 1.5;
    }

    /* Improve the appearance of the table container */
    .table-container {
        max-height: 70vh;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    /* Ensure proper alignment of table cells */
    .table td,
    .table th {
        vertical-align: middle;
    }

    /* Customer and segment column styling */
    .customer-column {
        background-color: #f8f9fa;
        font-weight: bold;
    }

    .segment-column {
        background-color: #e9ecef;
        font-weight: bold;
    }

    .crate-type-column {
        background-color: #fff3cd;
    }

    /* Loading spinner */
    .spinner-border {
        width: 1rem;
        height: 1rem;
        border-width: 0.2em;
    }

    /* Segment grouping */
    .segment-group {
        border-left: 3px solid #007bff;
    }

    /* Filter section */
    .filter-section {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }

    /* Add some spacing between filter and table */
    .results-section {
        margin-top: 20px;
    }
</style>

<div class="mt-3">
    <div class="card mb-3">
        <div class="card-header text-white p-1" style="background-color:#FC2947;">
            <div class="d-flex align-items-baseline">
                <a asp-action="Index" class="btn btn-link text-white"><i class="fa fa-arrow-left"></i></a>
                <h5 class="mx-auto text-white text-2xl font-semibold">Inward Entry - Record Crate Inward Quantities</h5>
            </div>
        </div>
        <div class="card-body">
            <div class="filter-section">
                <form id="filterForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="distributorId" class="control-label">Select Distributor</label>
                                <select name="distributorId" id="distributorId" class="form-control select2" required>
                                    @foreach (var distributor in ViewBag.Distributors)
                                    {
                                        <option value="@distributor.Value">@distributor.Text</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="segmentCode" class="control-label">Select Segment</label>
                                <select name="segmentCode" id="segmentDropdown" class="form-control" required>
                                    <option value="">----Select Distributor First----</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12 d-flex justify-content-end">
                            <button type="button" id="showCratesBtn" class="btn btn-primary">Show Crates</button>
                        </div>
                    </div>
                </form>
            </div>

            <div id="resultsSection" class="results-section" style="display: none;">
                <form asp-action="CratesInwardEntry" method="post" id="cratesForm">
                    <input type="hidden" name="distributorId" id="selectedDistributorId" />
                    <input type="hidden" name="segmentCode" id="selectedSegmentCode" />
                    <input type="hidden" name="entryDate" id="entryDate" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                    <div class="table-container table-responsive-sm">
                        <table class="table table-bordered table-striped table-hover table-fixed-header mb-0">
                            <thead>
                                <tr>
                                    <th class="align-middle">Crate Type</th>
                                    <th class="align-middle text-end">Inward Quantity</th>
                                </tr>
                            </thead>
                            <tbody id="crateQuantitiesBody">
                                <!-- Crate types will be loaded dynamically here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="px-4 text-right py-2 mt-3">
                        <a asp-action="Index"
                            class="btn hover:bg-red-700 bg-red-600 rounded-sm shadow-md text-white">Back</a>
                        <input type="submit" value="Save Inward Entry"
                            class="btn hover:bg-blue-700 bg-blue-600 rounded-sm shadow-md text-white" id="saveButton" />
                    </div>
                </form>
            </div>

            <div id="noDataMessage" class="alert alert-info" role="alert" style="display: none;">
                No crate types found for the selected segment.
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // Set today as default date
        document.addEventListener('DOMContentLoaded', function () {
            var today = new Date().toISOString().split('T')[0];
            document.getElementById('entryDate').value = today;
        });

        $(document).ready(function () {
            // Handle distributor dropdown change to load segments
            $('#distributorId').change(function () {
                var customerId = $(this).val();
                if (customerId) {
                    loadSegmentsForCustomer(customerId);
                } else {
                    $('#segmentDropdown').empty();
                    $('#segmentDropdown').append('<option value="">----Select Distributor First----</option>');
                    // Clear crate types when no distributor is selected
                    $('#crateQuantitiesBody').empty();
                    $('#resultsSection').hide();
                    $('#noDataMessage').hide();
                }
            });

            // Handle segment dropdown change
            $('#segmentDropdown').change(function () {
                // Just update the UI, actual crate loading happens on button click
            });

            // Handle show crates button click
            $('#showCratesBtn').click(function () {
                var customerId = $('#distributorId').val();
                var segmentCode = $('#segmentDropdown').val();
                var segmentText = $('#segmentDropdown option:selected').text();

                if (!customerId || !segmentCode || segmentText === "----Select Segment----") {
                    alert('Please select both a distributor and a segment.');
                    return;
                }

                // Set hidden fields
                $('#selectedDistributorId').val(customerId);
                $('#selectedSegmentCode').val(segmentCode);

                // Load crate types
                loadCrateTypesForSegment(segmentText);
            });

            // Handle Enter key press to move to next row
            $(document).on('keydown', '.inward-input', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    var currentIndex = parseInt($(this).data('index'));
                    var nextIndex = currentIndex + 1;
                    var nextInput = $('.inward-input[data-index="' + nextIndex + '"]');

                    if (nextInput.length > 0) {
                        nextInput.focus();
                    } else {
                        // If this is the last row, focus on the save button
                        $('#saveButton').focus();
                    }
                }
            });

            // Prevent form submission when pressing Enter in input fields
            $(document).on('keypress', '.inward-input', function (e) {
                if (e.which === 13) {
                    e.preventDefault();
                    return false;
                }
            });

            // Handle save button click with loading state
            $('#saveButton').on('click', function () {
                var $btn = $(this);
                $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...');
            });
        });

        function loadSegmentsForCustomer(customerId) {
            $.ajax({
                url: '@Url.Action("GetSegmentsForCustomer", "CratesManages")',
                type: 'GET',
                data: { customerId: customerId },
                success: function (result) {
                    $('#segmentDropdown').empty();
                    $('#segmentDropdown').append('<option value="">----Select Segment----</option>');
                    $.each(result, function (i, segment) {
                        $('#segmentDropdown').append($('<option></option>').val(segment.value).html(segment.text));
                    });
                    // Clear crate types when segments are loaded
                    $('#crateQuantitiesBody').empty();
                    $('#resultsSection').hide();
                    $('#noDataMessage').hide();
                },
                error: function () {
                    console.log('Error loading segments for customer');
                    $('#segmentDropdown').empty();
                    $('#segmentDropdown').append('<option value="">----Error Loading Segments----</option>');
                    // Clear crate types when there's an error
                    $('#crateQuantitiesBody').empty();
                    $('#resultsSection').hide();
                    $('#noDataMessage').hide();
                }
            });
        }

        function loadCrateTypesForSegment(segment) {
            $.ajax({
                url: '@Url.Action("GetCrateTypesForSegment", "CratesManages")',
                type: 'GET',
                data: { segment: segment },
                success: function (result) {
                    $('#crateQuantitiesBody').empty();
                    var hasData = false;
                    $.each(result, function (i, crateType) {
                        // Skip the default option
                        if (crateType.value !== "") {
                            var row = '<tr>' +
                                '<td>' + crateType.text + '</td>' +
                                '<td><input type="number" name="crateQuantities[' + crateType.value + ']" class="form-control form-control-sm text-end inward-input" min="0" value="0" data-index="' + i + '" style="min-width: 80px;" /></td>' +
                                '</tr>';
                            $('#crateQuantitiesBody').append(row);
                            hasData = true;
                        }
                    });

                    if (hasData) {
                        $('#resultsSection').show();
                        $('#noDataMessage').hide();
                    } else {
                        $('#resultsSection').hide();
                        $('#noDataMessage').show();
                    }
                },
                error: function () {
                    console.log('Error loading crate types for segment');
                    $('#crateQuantitiesBody').empty();
                    $('#crateQuantitiesBody').append('<tr><td colspan="2">Error loading crate types</td></tr>');
                    $('#resultsSection').hide();
                    $('#noDataMessage').hide();
                }
            });
        }
    </script>
}