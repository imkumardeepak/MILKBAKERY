@model Milk_Bakery.ViewModels.VarianceOrderReportViewModel

@{
    ViewData["Title"] = "Variance Order Report";
    Layout = "~/Views/Shared/_Layout.cshtml";
    string role = Context.Request.HttpContext.Session.GetString("role");
}

<div class="mt-3">
    <div class="card mb-3">
        <div class="card-header text-white p-1" style="background-color:#FC2947;">
            <div class="d-flex align-items-baseline">
                <a href="/Home/Index" class="btn btn-link text-white"><i class="fa fa-arrow-left"></i></a>
                <h5 class="mx-auto text-white text-2xl font-semibold">Variance Order Report</h5>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-lg-12">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Report Filters</h6>
                        </div>
                        <div class="card-body">
                            <form asp-action="GenerateReport" method="post">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="FromDate" class="font-weight-bold">From Date:</label>
                                            <input type="date" class="form-control" asp-for="FromDate" />
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="ToDate" class="font-weight-bold">To Date:</label>
                                            <input type="date" class="form-control" asp-for="ToDate" />
                                        </div>
                                    </div>
                                    @if (role != "Customer")
                                    {
                                        <div class="col-md-4">
                                            <div class="form-group">
                                                <label for="CustomerName" class="font-weight-bold">Customer:</label>
                                                <select class="form-control select2" asp-for="CustomerName" asp-items="@(new SelectList(Model.AvailableCustomers))">
                                                    <option value="">-- All Customers --</option>
                                                </select>
                                            </div>
                                        </div>
                                    }
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group form-check">
                                            <input type="checkbox" class="form-check-input" asp-for="ShowOnlyVariance" />
                                            <label class="form-check-label font-weight-bold" asp-for="ShowOnlyVariance">Show Only Items with Variance</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-chart-bar"></i> Generate Report
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            @if (Model.ReportItems != null && Model.ReportItems.Any())
            {
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                                <h6 class="m-0 font-weight-bold text-primary">Variance Report</h6>
                                <button class="btn btn-success" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel"></i> Export to Excel
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover" id="varianceReportTable">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th>Customer Name</th>
                                                <th>Material Name</th>
                                                <th>Material Code</th>
                                                <th>Ordered Qty</th>
                                                <th>Invoiced Qty</th>
                                                <th>Qty Variance</th>
                                                <th>Ordered Amount</th>
                                                <th>Invoiced Amount</th>
                                                <th>Amount Variance</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in Model.ReportItems)
                                            {
                                                <tr>
                                                    <td>@item.CustomerName</td>
                                                    <td>@item.MaterialName</td>
                                                    <td>@item.MaterialCode</td>
                                                    <td class="text-right">@item.OrderedQuantity</td>
                                                    <td class="text-right">@item.InvoicedQuantity</td>
                                                    <td class="text-right @(item.QuantityVariance != 0 ? "font-weight-bold" : "") @(item.QuantityVariance > 0 ? "text-danger" : "text-success")">@item.QuantityVariance</td>
                                                    <td class="text-right">@item.OrderedAmount.ToString("F2")</td>
                                                    <td class="text-right">@item.InvoicedAmount.ToString("F2")</td>
                                                    <td class="text-right @(item.AmountVariance != 0 ? "font-weight-bold" : "") @(item.AmountVariance > 0 ? "text-danger" : "text-success")">@item.AmountVariance.ToString("F2")</td>
                                                </tr>
                                            }
                                        </tbody>
                                        <tfoot class="thead-dark">
                                            <tr>
                                                <th colspan="3" class="text-right">Total:</th>
                                                <th class="text-right">@Model.ReportItems.Sum(i => i.OrderedQuantity)</th>
                                                <th class="text-right">@Model.ReportItems.Sum(i => i.InvoicedQuantity)</th>
                                                <th class="text-right">@Model.ReportItems.Sum(i => i.QuantityVariance)</th>
                                                <th class="text-right">@Model.ReportItems.Sum(i => i.OrderedAmount).ToString("F2")</th>
                                                <th class="text-right">@Model.ReportItems.Sum(i => i.InvoicedAmount).ToString("F2")</th>
                                                <th class="text-right">@Model.ReportItems.Sum(i => i.AmountVariance).ToString("F2")</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else if (Model.FromDate.HasValue && Model.ToDate.HasValue)
            {
                <div class="row">
                    <div class="col-lg-12">
                        <div class="alert alert-info text-center" role="alert">
                            <i class="fas fa-info-circle"></i> No variance data found for the selected criteria.
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Initialize Select2
            $('.select2').select2();

            // Initialize DataTable
            $('#varianceReportTable').DataTable({
                "pageLength": 25,
                "ordering": true,
                "info": true,
                "lengthChange": true,
                "dom": 'Bfrtip',
                "buttons": [
                    'copy', 'csv', 'excel', 'pdf', 'print'
                ]
            });
        });

        function exportToExcel() {
            // Simple export to Excel functionality
            $("#varianceReportTable").table2excel({
                filename: "VarianceOrderReport.xls"
            });
        }
    </script>
}