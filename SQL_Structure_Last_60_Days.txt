# Milk & Bakery Management System - Database Structure (Last 60 Days)

This document outlines the database structure changes based on Entity Framework migrations from the last 60 days (August 7, 2025 - September 16, 2025).

## Migration Timeline

### August 7, 2025
**Initial Crates Types Table Creation**
```sql
CREATE TABLE [CratesTypes] (
    [Id] int NOT NULL IDENTITY,
    [Cratestype] nvarchar(max) NOT NULL,
    [Width] nvarchar(max) NOT NULL,
    [Height] nvarchar(max) NOT NULL,
    [Length] nvarchar(max) NOT NULL,
    CONSTRAINT [PK_CratesTypes] PRIMARY KEY ([Id])
);
```

### August 8, 2025
**Add CratesCode Column to CratesTypes**
```sql
ALTER TABLE [CratesTypes] ADD [CratesCode] nvarchar(max) NOT NULL DEFAULT '';
```

**Modify CratesTypes Columns**
```sql
-- First, remove the default constraint if it exists
DECLARE @var0 sysname;
SELECT @var0 = [d].[name]
FROM [sys].[default_constraints] [d]
INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
WHERE ([d].[parent_object_id] = OBJECT_ID(N'[CratesTypes]') AND [c].[name] = N'Cratestype');
IF @var0 IS NOT NULL EXEC(N'ALTER TABLE [CratesTypes] DROP CONSTRAINT [' + @var0 + '];');
ALTER TABLE [CratesTypes] ALTER COLUMN [Cratestype] nvarchar(50) NOT NULL;

-- Remove default constraint for CratesCode if it exists
DECLARE @var1 sysname;
SELECT @var1 = [d].[name]
FROM [sys].[default_constraints] [d]
INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
WHERE ([d].[parent_object_id] = OBJECT_ID(N'[CratesTypes]') AND [c].[name] = N'CratesCode');
IF @var1 IS NOT NULL EXEC(N'ALTER TABLE [CratesTypes] DROP CONSTRAINT [' + @var1 + '];');
ALTER TABLE [CratesTypes] ALTER COLUMN [CratesCode] nvarchar(1) NOT NULL;
```

**Add CratesCode to MaterialMaster**
```sql
ALTER TABLE [MaterialMaster] ADD [CratesCode] nvarchar(1) NOT NULL DEFAULT '';
```

### August 23, 2025
**Create Invoices and InvoiceMaterials Tables**
```sql
CREATE TABLE [Invoices] (
    [InvoiceId] int NOT NULL IDENTITY,
    [InvoiceNo] nvarchar(50) NOT NULL,
    [InvoiceDate] datetime2 NOT NULL,
    [CustomerRefPO] nvarchar(50) NOT NULL,
    [TotalAmount] decimal(18,2) NOT NULL,
    [OrderDate] datetime2 NOT NULL,
    [BillToName] nvarchar(200) NOT NULL,
    [BillToCode] nvarchar(50) NOT NULL,
    [ShipToName] nvarchar(200) NOT NULL,
    [ShipToCode] nvarchar(50) NOT NULL,
    [ShipToRoute] nvarchar(100) NOT NULL,
    [CompanyName] nvarchar(200) NOT NULL,
    [CompanyCode] nvarchar(50) NOT NULL,
    [VehicleNo] nvarchar(50) NOT NULL,
    CONSTRAINT [PK_Invoices] PRIMARY KEY ([InvoiceId])
);

CREATE TABLE [InvoiceMaterials] (
    [MaterialId] int NOT NULL IDENTITY,
    [InvoiceId] int NOT NULL,
    [ProductDescription] nvarchar(200) NOT NULL,
    [MaterialSapCode] nvarchar(50) NOT NULL,
    [Batch] nvarchar(50) NULL,
    [UnitPerCase] int NOT NULL,
    [QuantityCases] int NOT NULL,
    [QuantityUnits] int NOT NULL,
    [UOM] nvarchar(20) NOT NULL,
    CONSTRAINT [PK_InvoiceMaterials] PRIMARY KEY ([MaterialId]),
    CONSTRAINT [FK_InvoiceMaterials_Invoices_InvoiceId] FOREIGN KEY ([InvoiceId]) REFERENCES [Invoices] ([InvoiceId]) ON DELETE CASCADE
);

CREATE INDEX [IX_InvoiceMaterials_InvoiceId_MaterialId] ON [InvoiceMaterials] ([InvoiceId], [MaterialId]);
CREATE INDEX [IX_Invoices_InvoiceId_ShipToCode_BillToCode_InvoiceDate_VehicleNo] ON [Invoices] ([InvoiceId], [ShipToCode], [BillToCode], [InvoiceDate], [VehicleNo]);
```

### September 5, 2025
**Create Dealer Master and Order Tables**
```sql
CREATE TABLE [DealerMasters] (
    [Id] int NOT NULL IDENTITY,
    [DistributorId] int NOT NULL,
    [Name] nvarchar(200) NOT NULL,
    [RouteCode] nvarchar(50) NOT NULL,
    [Address] nvarchar(500) NOT NULL,
    [City] nvarchar(100) NOT NULL,
    [PhoneNo] nvarchar(10) NOT NULL,
    [Email] nvarchar(100) NOT NULL,
    CONSTRAINT [PK_DealerMasters] PRIMARY KEY ([Id])
);

CREATE TABLE [DealerBasicOrders] (
    [Id] int NOT NULL IDENTITY,
    [DealerId] int NOT NULL,
    [MaterialName] nvarchar(200) NOT NULL,
    [SapCode] nvarchar(50) NOT NULL,
    [ShortCode] nvarchar(50) NOT NULL,
    [Quantity] int NOT NULL,
    [BasicAmount] decimal(18,2) NOT NULL,
    CONSTRAINT [PK_DealerBasicOrders] PRIMARY KEY ([Id]),
    CONSTRAINT [FK_DealerBasicOrders_DealerMasters_DealerId] FOREIGN KEY ([DealerId]) REFERENCES [DealerMasters] ([Id]) ON DELETE CASCADE
);

CREATE INDEX [IX_DealerBasicOrders_DealerId] ON [DealerBasicOrders] ([DealerId]);
```

**Modify Dealer Master Email Default Value**
```sql
-- Remove any existing default constraint
DECLARE @var2 sysname;
SELECT @var2 = [d].[name]
FROM [sys].[default_constraints] [d]
INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
WHERE ([d].[parent_object_id] = OBJECT_ID(N'[DealerMasters]') AND [c].[name] = N'Email');
IF @var2 IS NOT NULL EXEC(N'ALTER TABLE [DealerMasters] DROP CONSTRAINT [' + @var2 + '];');

-- Add new default value
ALTER TABLE [DealerMasters] ADD CONSTRAINT [DF_DealerMasters_Email] DEFAULT N'N/A' FOR [Email];
```

**Remove Dealer Master Email Default Value**
```sql
-- Remove the default constraint
DECLARE @var3 sysname;
SELECT @var3 = [d].[name]
FROM [sys].[default_constraints] [d]
INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
WHERE ([d].[parent_object_id] = OBJECT_ID(N'[DealerMasters]') AND [c].[name] = N'Email');
IF @var3 IS NOT NULL EXEC(N'ALTER TABLE [DealerMasters] DROP CONSTRAINT [' + @var3 + '];');
```

**Make Dealer Master Email Nullable**
```sql
-- Remove any existing default constraint
DECLARE @var4 sysname;
SELECT @var4 = [d].[name]
FROM [sys].[default_constraints] [d]
INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
WHERE ([d].[parent_object_id] = OBJECT_ID(N'[DealerMasters]') AND [c].[name] = N'Email');
IF @var4 IS NOT NULL EXEC(N'ALTER TABLE [DealerMasters] DROP CONSTRAINT [' + @var4 + '];');

-- Alter column to make it nullable
ALTER TABLE [DealerMasters] ALTER COLUMN [Email] nvarchar(100) NULL;
```

### September 8, 2025
**Create Dealer Orders Tables**
```sql
CREATE TABLE [DealerOrders] (
    [Id] int NOT NULL IDENTITY,
    [OrderDate] datetime2 NOT NULL,
    [DistributorId] int NOT NULL,
    [DealerId] int NOT NULL,
    [DistributorCode] nvarchar(50) NOT NULL,
    [ProcessFlag] int NOT NULL,
    CONSTRAINT [PK_DealerOrders] PRIMARY KEY ([Id])
);

CREATE TABLE [DealerOrderItems] (
    [Id] int NOT NULL IDENTITY,
    [DealerOrderId] int NOT NULL,
    [MaterialName] nvarchar(200) NOT NULL,
    [ShortCode] nvarchar(10) NOT NULL,
    [SapCode] nvarchar(50) NOT NULL,
    [Qty] int NOT NULL,
    [Rate] decimal(18,2) NOT NULL,
    [Price] decimal(18,2) NOT NULL,
    CONSTRAINT [PK_DealerOrderItems] PRIMARY KEY ([Id]),
    CONSTRAINT [FK_DealerOrderItems_DealerOrders_DealerOrderId] FOREIGN KEY ([DealerOrderId]) REFERENCES [DealerOrders] ([Id]) ON DELETE CASCADE
);

CREATE INDEX [IX_DealerOrderItems_DealerOrderId_SapCode_ShortCode] ON [DealerOrderItems] ([DealerOrderId], [SapCode], [ShortCode]);
CREATE INDEX [IX_DealerOrders_OrderDate_DealerId_DistributorId_ProcessFlag] ON [DealerOrders] ([OrderDate], [DealerId], [DistributorId], [ProcessFlag]);
```

**Update Dealer Order Date Format**
```sql
-- Change OrderDate column type from datetime2 to date
ALTER TABLE [DealerOrders] ALTER COLUMN [OrderDate] date NOT NULL;
```

### September 9, 2025
**Create Crates Management Table**
```sql
CREATE TABLE [CratesManages] (
    [Id] int NOT NULL IDENTITY,
    [CustomerId] int NOT NULL,
    [SegmentCode] nvarchar(50) NOT NULL,
    [DispDate] datetime2 NOT NULL,
    [Opening] int NOT NULL,
    [Outward] int NOT NULL,
    [Inward] int NOT NULL,
    [Balance] int NOT NULL,
    CONSTRAINT [PK_CratesManages] PRIMARY KEY ([Id]),
    CONSTRAINT [FK_CratesManages_Customer_Master_CustomerId] FOREIGN KEY ([CustomerId]) REFERENCES [Customer_Master] ([Id]) ON DELETE CASCADE
);

CREATE INDEX [IX_CratesManages_CustomerId] ON [CratesManages] ([CustomerId]);
```

**Update Crates Management Date Format**
```sql
-- Change DispDate column type from datetime2 to Date
ALTER TABLE [CratesManages] ALTER COLUMN [DispDate] date NOT NULL;
```

### September 10, 2025
**Add Crates Type ID to Crates Management**
```sql
ALTER TABLE [CratesManages] ADD [CratesTypeId] int NULL;

CREATE INDEX [IX_CratesManages_CratesTypeId] ON [CratesManages] ([CratesTypeId]);

ALTER TABLE [CratesManages] ADD CONSTRAINT [FK_CratesManages_CratesTypes_CratesTypeId] FOREIGN KEY ([CratesTypeId]) REFERENCES [CratesTypes] ([Id]);
```

### September 11, 2025
**Add Sequence Column to Customer Master**
```sql
ALTER TABLE [Customer_Master] ADD [Sequence] int NOT NULL DEFAULT 0;

CREATE INDEX [IX_CustomerMaster_Sequence] ON [Customer_Master] ([Sequence]);
```

### September 13, 2025
**Add Division to CratesType**
```sql
ALTER TABLE [CratesTypes] ADD [Division] nvarchar(max) NOT NULL DEFAULT '';
```

**Manually Update CratesCode Length**
```sql
ALTER TABLE [CratesTypes] ALTER COLUMN [CratesCode] nvarchar(2) NOT NULL;
```

**Remove CratesCode Columns and Add CratesTypes**
```sql
-- Remove CratesCode columns
ALTER TABLE [MaterialMaster] DROP COLUMN [CratesCode];
ALTER TABLE [CratesTypes] DROP COLUMN [CratesCode];

-- Add CratesTypes column to MaterialMaster
ALTER TABLE [MaterialMaster] ADD [CratesTypes] nvarchar(max) NOT NULL DEFAULT '';
```

### September 15, 2025
**Add Role and Page Access Models**
```sql
CREATE TABLE [Roles] (
    [Id] int NOT NULL IDENTITY,
    [RoleName] nvarchar(max) NOT NULL,
    CONSTRAINT [PK_Roles] PRIMARY KEY ([Id])
);

CREATE TABLE [PageAccesses] (
    [Id] int NOT NULL IDENTITY,
    [PageName] nvarchar(max) NOT NULL,
    [HasAccess] bit NOT NULL,
    [RoleId] int NOT NULL,
    CONSTRAINT [PK_PageAccesses] PRIMARY KEY ([Id]),
    CONSTRAINT [FK_PageAccesses_Roles_RoleId] FOREIGN KEY ([RoleId]) REFERENCES [Roles] ([Id]) ON DELETE CASCADE
);

CREATE INDEX [IX_PageAccesses_RoleId] ON [PageAccesses] ([RoleId]);
```

### September 16, 2025
**Add MenuItem Model**
```sql
CREATE TABLE [MenuItems] (
    [Id] int NOT NULL IDENTITY,
    [Name] nvarchar(max) NOT NULL,
    [Controller] nvarchar(max) NULL,
    [Action] nvarchar(max) NULL,
    [Url] nvarchar(max) NULL,
    [ParentId] int NULL,
    CONSTRAINT [PK_MenuItems] PRIMARY KEY ([Id])
);
```

## Final Database Structure (as of September 16, 2025)

### CratesTypes
```sql
CREATE TABLE [CratesTypes] (
    [Id] int NOT NULL IDENTITY,
    [Cratestype] nvarchar(50) NOT NULL,
    [Width] nvarchar(max) NOT NULL,
    [Height] nvarchar(max) NOT NULL,
    [Length] nvarchar(max) NOT NULL,
    [Division] nvarchar(max) NOT NULL,
    CONSTRAINT [PK_CratesTypes] PRIMARY KEY ([Id])
);
```

### MaterialMaster
```sql
-- MaterialMaster table with updated structure
-- Note: CratesCode column was removed and replaced with CratesTypes column
ALTER TABLE [MaterialMaster] ADD [CratesTypes] nvarchar(max) NOT NULL DEFAULT '';
```

### Invoices
```sql
CREATE TABLE [Invoices] (
    [InvoiceId] int NOT NULL IDENTITY,
    [InvoiceNo] nvarchar(50) NOT NULL,
    [InvoiceDate] datetime2 NOT NULL,
    [CustomerRefPO] nvarchar(50) NOT NULL,
    [TotalAmount] decimal(18,2) NOT NULL,
    [OrderDate] datetime2 NOT NULL,
    [BillToName] nvarchar(200) NOT NULL,
    [BillToCode] nvarchar(50) NOT NULL,
    [ShipToName] nvarchar(200) NOT NULL,
    [ShipToCode] nvarchar(50) NOT NULL,
    [ShipToRoute] nvarchar(100) NOT NULL,
    [CompanyName] nvarchar(200) NOT NULL,
    [CompanyCode] nvarchar(50) NOT NULL,
    [VehicleNo] nvarchar(50) NOT NULL,
    [setflag] int NULL DEFAULT 0,
    CONSTRAINT [PK_Invoices] PRIMARY KEY ([InvoiceId])
);
```

### InvoiceMaterials
```sql
CREATE TABLE [InvoiceMaterials] (
    [MaterialId] int NOT NULL IDENTITY,
    [InvoiceId] int NOT NULL,
    [ProductDescription] nvarchar(200) NOT NULL,
    [MaterialSapCode] nvarchar(50) NOT NULL,
    [Batch] nvarchar(50) NULL,
    [UnitPerCase] int NOT NULL,
    [QuantityCases] int NOT NULL,
    [QuantityUnits] int NOT NULL,
    [UOM] nvarchar(20) NOT NULL,
    CONSTRAINT [PK_InvoiceMaterials] PRIMARY KEY ([MaterialId]),
    CONSTRAINT [FK_InvoiceMaterials_Invoices_InvoiceId] FOREIGN KEY ([InvoiceId]) REFERENCES [Invoices] ([InvoiceId]) ON DELETE CASCADE
);
```

### DealerMasters
```sql
CREATE TABLE [DealerMasters] (
    [Id] int NOT NULL IDENTITY,
    [DistributorId] int NOT NULL,
    [Name] nvarchar(200) NOT NULL,
    [RouteCode] nvarchar(50) NOT NULL,
    [Address] nvarchar(500) NOT NULL,
    [City] nvarchar(100) NOT NULL,
    [PhoneNo] nvarchar(10) NOT NULL,
    [Email] nvarchar(100) NULL,
    CONSTRAINT [PK_DealerMasters] PRIMARY KEY ([Id])
);
```

### DealerBasicOrders
```sql
CREATE TABLE [DealerBasicOrders] (
    [Id] int NOT NULL IDENTITY,
    [DealerId] int NOT NULL,
    [MaterialName] nvarchar(200) NOT NULL,
    [SapCode] nvarchar(50) NOT NULL,
    [ShortCode] nvarchar(50) NOT NULL,
    [Quantity] int NOT NULL,
    [BasicAmount] decimal(18,2) NOT NULL,
    CONSTRAINT [PK_DealerBasicOrders] PRIMARY KEY ([Id]),
    CONSTRAINT [FK_DealerBasicOrders_DealerMasters_DealerId] FOREIGN KEY ([DealerId]) REFERENCES [DealerMasters] ([Id]) ON DELETE CASCADE
);
```

### DealerOrders
```sql
CREATE TABLE [DealerOrders] (
    [Id] int NOT NULL IDENTITY,
    [OrderDate] date NOT NULL,
    [DistributorId] int NOT NULL,
    [DealerId] int NOT NULL,
    [DistributorCode] nvarchar(50) NOT NULL,
    [ProcessFlag] int NOT NULL,
    CONSTRAINT [PK_DealerOrders] PRIMARY KEY ([Id])
);
```

### DealerOrderItems
```sql
CREATE TABLE [DealerOrderItems] (
    [Id] int NOT NULL IDENTITY,
    [DealerOrderId] int NOT NULL,
    [MaterialName] nvarchar(200) NOT NULL,
    [ShortCode] nvarchar(10) NOT NULL,
    [SapCode] nvarchar(50) NOT NULL,
    [Qty] int NOT NULL,
    [Rate] decimal(18,2) NOT NULL,
    [Price] decimal(18,2) NOT NULL,
    CONSTRAINT [PK_DealerOrderItems] PRIMARY KEY ([Id]),
    CONSTRAINT [FK_DealerOrderItems_DealerOrders_DealerOrderId] FOREIGN KEY ([DealerOrderId]) REFERENCES [DealerOrders] ([Id]) ON DELETE CASCADE
);
```

### CratesManages
```sql
CREATE TABLE [CratesManages] (
    [Id] int NOT NULL IDENTITY,
    [CustomerId] int NOT NULL,
    [SegmentCode] nvarchar(50) NOT NULL,
    [DispDate] date NOT NULL,
    [Opening] int NOT NULL,
    [Outward] int NOT NULL,
    [Inward] int NOT NULL,
    [Balance] int NOT NULL,
    [CratesTypeId] int NULL,
    CONSTRAINT [PK_CratesManages] PRIMARY KEY ([Id]),
    CONSTRAINT [FK_CratesManages_Customer_Master_CustomerId] FOREIGN KEY ([CustomerId]) REFERENCES [Customer_Master] ([Id]) ON DELETE CASCADE,
    CONSTRAINT [FK_CratesManages_CratesTypes_CratesTypeId] FOREIGN KEY ([CratesTypeId]) REFERENCES [CratesTypes] ([Id])
);
```

### Customer_Master
```sql
-- Customer_Master table with added Sequence column
ALTER TABLE [Customer_Master] ADD [Sequence] int NOT NULL DEFAULT 0;
```

### Roles and PageAccesses
```sql
CREATE TABLE [Roles] (
    [Id] int NOT NULL IDENTITY,
    [RoleName] nvarchar(max) NOT NULL,
    CONSTRAINT [PK_Roles] PRIMARY KEY ([Id])
);

CREATE TABLE [PageAccesses] (
    [Id] int NOT NULL IDENTITY,
    [PageName] nvarchar(max) NOT NULL,
    [HasAccess] bit NOT NULL,
    [RoleId] int NOT NULL,
    CONSTRAINT [PK_PageAccesses] PRIMARY KEY ([Id]),
    CONSTRAINT [FK_PageAccesses_Roles_RoleId] FOREIGN KEY ([RoleId]) REFERENCES [Roles] ([Id]) ON DELETE CASCADE
);
```

### MenuItems
```sql
CREATE TABLE [MenuItems] (
    [Id] int NOT NULL IDENTITY,
    [Name] nvarchar(max) NOT NULL,
    [Controller] nvarchar(max) NULL,
    [Action] nvarchar(max) NULL,
    [Url] nvarchar(max) NULL,
    [ParentId] int NULL,
    CONSTRAINT [PK_MenuItems] PRIMARY KEY ([Id])
);
```